<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cosmic Games</title>
<link rel="icon" href="favicon.ico">
<style>
:root{
  --bg:#070814; --panel:#0c1133; --edge:#2a3180; --ink:#e9eeff; --mut:#a9b4d8;
  --acc:#7aa2ff; --win:#43f57a; --lose:#ff6b6b;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
a{color:inherit}
button{background:#12183f;border:1px solid var(--edge);color:var(--ink);border-radius:12px;padding:.6rem 1rem;font-weight:700;cursor:pointer;transition:.15s}
button:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(122,162,255,.18)}
button:disabled{opacity:.55;cursor:not-allowed}
.ghost{background:transparent}
.accent{background:linear-gradient(180deg,#3949d4,#222d99);border-color:#4b5aee}
.small{padding:.4rem .7rem;border-radius:10px}
.pill{display:inline-flex;gap:.55rem;align-items:center;padding:.45rem .7rem;border:1px solid var(--edge);border-radius:999px;background:#0c1033}
.badge{padding:.25rem .55rem;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#101747;font-size:.86rem}
.hidden{display:none}

.top{position:sticky;top:0;z-index:15;display:flex;justify-content:space-between;align-items:center;gap:12px;padding:14px 18px;background:linear-gradient(180deg,rgba(11,13,34,.9),rgba(11,13,34,.55));border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:saturate(140%) blur(8px)}
.brand{display:flex;align-items:center;gap:.7rem;font-weight:900;letter-spacing:.6px}
.logo{width:28px;height:28px;border-radius:8px;overflow:hidden}

.grid{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;gap:16px}
.stage{position:relative;border-radius:16px;border:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,rgba(12,16,51,.96),rgba(7,8,20,.96));padding:16px;box-shadow:0 10px 40px rgba(10,12,30,.35)}
h1,h2{margin:.25rem 0 1rem}

/* BACKDROP */
canvas.bg{position:fixed;inset:0;z-index:0;pointer-events:none;display:block}

/* Landing list (vertical) */
.nav-list{display:grid;grid-template-columns:1fr;gap:14px}
.tile{display:flex;align-items:center;gap:14px;background:linear-gradient(180deg,#12183f,#0b0f31);border:1px solid var(--edge);border-radius:14px;padding:14px}
.tile .desc{flex:1;color:var(--mut)}
.tile .actions{display:flex;gap:10px}

/* Tabs */
.tabs{display:flex;gap:10px;margin-bottom:10px}
.tab{padding:.5rem .9rem;border-radius:10px;border:1px solid var(--edge);background:#0b0f31;cursor:pointer}
.tab.active{background:#1a2264}

/* Avatars */
.avatar-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(92px,1fr));gap:12px}
.avatar{width:92px;height:92px;border-radius:14px;border:2px solid transparent;background:#0b0e2b;display:grid;place-items:center;cursor:pointer}
.avatar.active{border-color:var(--acc);box-shadow:0 0 0 3px rgba(122,162,255,.25)}
#avatarPreview{width:96px;height:96px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:#0c1033;object-fit:cover}

/* Blackjack */
.banner{display:flex;align-items:center;justify-content:center;gap:.6rem;padding:.45rem .8rem;border-radius:999px;background:#0e153f;border:1px solid var(--edge)}
.banner.win{color:var(--win);border-color:#2f6f4f;background:#0b2e1a}
.banner.lose{color:var(--lose);border-color:#6f2f2f;background:#2e0b0b}
.rules-note{font-size:.85rem;color:#cfe0ff9c}
.hand{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.card{width:74px;height:104px;border-radius:10px;background:#f4f7ff;border:1px solid #ccd5ff;box-shadow:0 6px 18px rgba(0,0,0,.25);display:grid;grid-template-rows:auto 1fr auto;position:relative;overflow:hidden}
.card .rank{font-weight:900;font-size:18px;padding:6px 8px}
.card .suit{font-size:20px;padding:0 8px}
.card .pips{display:grid;place-items:center;font-size:28px;color:currentColor;margin-bottom:6px}
.card.red{color:#b10c2b}.card.black{color:#111}
.card.back{background:repeating-linear-gradient(45deg,#102255 0 8px,#0c1a44 8px 16px),radial-gradient(600px 600px at 10% 10%, rgba(255,255,255,.08), transparent 60%);border-color:#20337a}
@keyframes dealIn{from{transform:translateY(-12px) scale(.98);opacity:0}to{transform:none;opacity:1}}
@keyframes flipIn{from{transform:rotateY(-90deg)}to{transform:rotateY(0)}}
.card.deal-in{animation:dealIn .22s ease-out both}
.card.flip-in{animation:flipIn .25s ease-out both;transform-style:preserve-3d;backface-visibility:hidden}

.controls{display:flex;gap:18px;justify-content:center;margin-top:10px;flex-wrap:wrap}
.rack{display:flex;gap:16px;align-items:center;justify-content:center;flex-wrap:wrap}
.chip-emoji{width:56px;height:56px;border-radius:14px;display:grid;place-items:center;padding:0;background:linear-gradient(180deg,#14194a,#0d1238);border:1px solid var(--edge);color:#fff;font-size:22px;line-height:1;user-select:none;transition:transform .12s;box-shadow:0 6px 18px rgba(0,0,0,.35),0 0 0 1px rgba(120,140,255,.18) inset}
.chip-emoji:active{transform:scale(.95)}
.chip-wrap{display:grid;justify-items:center}
.chip-label{font-size:12px;font-weight:800;color:#fff;margin-top:4px;text-align:center}
.bet-tray{min-height:60px;min-width:280px;padding:10px;border-radius:14px;border:1px dashed rgba(255,255,255,.25);background:rgba(12,16,48,.35);display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.bet-token{width:56px;height:56px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(180deg,#14194a,#0d1238);border:1px solid var(--edge);font-size:22px;cursor:pointer;position:relative;animation:drop .18s ease-out}
.bet-token:after{content:attr(data-label);position:absolute;bottom:-15px;left:50%;transform:translateX(-50%);font-size:12px;font-weight:800;color:#fff}
@keyframes drop{from{transform:translateY(-12px);opacity:0}to{transform:translateY(0);opacity:1}}

/* Pool */
.pool-toolbar{display:flex;gap:10px;justify-content:space-between;align-items:center}
.pool-outer{position:relative;display:grid;place-items:center}
.pool-frame{width:100%;max-width:1100px;aspect-ratio:2/1;border-radius:18px;border:1px solid rgba(160,190,255,.14);padding:12px;background:radial-gradient(800px 480px at 50% 30%,rgba(120,160,255,.08),transparent 60%),linear-gradient(#0a1436,#071025)}
.pool-canvas{width:100%;height:100%;border-radius:14px;display:block;background:#0f3432}
.powerbar{height:10px;background:#14204a;border:1px solid #2a3180;border-radius:999px;overflow:hidden}
.powerbar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#47f,#7af);transition:width .06s}

/* Pocket rails + group tags */
.rails{display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:10px}
.hrail{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.balldot{width:14px;height:14px;border-radius:50%;background:#fff;border:1px solid #000}
.hrail .title{margin-right:6px;color:var(--mut);font-size:.9rem}

/* Help pop */
.help-pop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:30}
.help-card{position:relative;max-width:680px;background:#0c1133;border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:18px}
.help-close{position:absolute;top:8px;right:12px;cursor:pointer;font-weight:900}

/* Fullscreen tweaks */
body.fs-bj #blackjack .stage{max-width:min(1400px,95vw);margin-inline:auto}
</style>
</head>
<body>
<canvas id="bg" class="bg"></canvas>

<header class="top">
  <div class="brand"><div class="logo" id="logo"></div>Cosmic Games</div>
  <div class="flex">
    <div class="pill">ðŸ‘¤ <input id="username" placeholder="Enter username" style="width:170px"><button id="saveUser" class="ghost small">Save</button></div>
    <button id="openCustomize" class="accent small">Customization</button>
    <div class="pill">ðŸ’° Balance: <b id="bal">$0</b></div>
    <button id="resetBank" class="ghost small">Reset Balance</button>
    <button id="muteBtn" class="ghost small">ðŸ”Š</button>
  </div>
</header>

<main class="grid">
  <!-- Landing -->
  <section id="landing" class="stage">
    <h1>Welcome to <span style="color:var(--acc)">Cosmic Games</span> âœ¨</h1>
    <p class="muted">Pick a game. Your name, avatar, calling card, and balance save locally.</p>
    <div class="nav-list">
      <div class="tile">
        <div class="badge">Blackjack</div>
        <div class="desc">Space table with sounds, instant win on 21, chip debounce, fullscreen.</div>
        <div class="actions"><button class="accent go" data-go="blackjack">Play</button></div>
      </div>
      <div class="tile">
        <div class="badge">8-Ball Pool</div>
        <div class="desc">Solids/Stripes vs AI. Power pull, ball-in-hand, rails, help bubble, fullscreen.</div>
        <div class="actions"><button class="accent go" data-go="pool">Play</button></div>
      </div>
      <div class="tile"><div class="badge">CHESS IN PROGRESS</div><div class="desc">Stay tunedâ€¦</div><div class="actions"><button class="ghost" disabled>Coming soon</button></div></div>
      <div class="tile"><div class="badge">SECRET GAME</div><div class="desc">Top secret project.</div><div class="actions"><button class="ghost" disabled>Locked</button></div></div>
      <div class="tile"><div class="badge">SECRET GAME</div><div class="desc">Top secret project.</div><div class="actions"><button class="ghost" disabled>Locked</button></div></div>
    </div>
  </section>

  <!-- Customization -->
  <section id="customize" class="stage hidden">
    <h2>Customization</h2>
    <div class="tabs">
      <div class="tab active" data-tab="tAv">Avatars</div>
      <div class="tab" data-tab="tCard">Calling card</div>
    </div>

    <div id="tAv">
      <div class="flex" style="align-items:center;gap:12px">
        <div>
          <div class="muted" style="margin-bottom:6px">Your avatar</div>
          <img id="avatarPreview" alt="avatar">
        </div>
        <button id="saveAvatar" class="accent">Save Avatar</button>
      </div>
      <div class="muted" style="margin:12px 0 8px">Choose one of 5 avatars:</div>
      <div id="avatarGrid" class="avatar-grid"></div>
    </div>

    <div id="tCard" class="hidden">
      <div class="flex" style="gap:16px;align-items:end">
        <div>
          <div class="muted" style="margin-bottom:6px">Calling card text</div>
          <input id="cardText" placeholder="e.g., THE GOAT">
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px">Calling card color</div>
          <select id="cardColor">
            <option value="#7aa2ff">Blue</option>
            <option value="#8ef5ff">Cyan</option>
            <option value="#ffb86b">Orange</option>
            <option value="#43f57a">Green</option>
            <option value="#ff6b6b">Red</option>
          </select>
        </div>
        <button id="saveCard" class="accent">Save Card</button>
      </div>
    </div>
    <div class="controls"><button class="ghost go" data-go="landing">Back</button></div>
  </section>

  <!-- Blackjack -->
  <section id="blackjack" class="stage hidden">
    <div class="flex" style="justify-content:space-between;align-items:center">
      <div class="banner" id="bjMsg">Select a bet first.</div>
      <div class="flex" style="gap:8px">
        <span class="rules-note">Instant win at 21 â€¢ Dealer stands on 17</span>
        <button id="bjFull" class="ghost">â¤¢ Fullscreen</button>
        <button id="bjExit" class="ghost hidden">â¤¡ Exit</button>
        <button class="ghost go" data-go="landing">Back</button>
      </div>
    </div>

    <div class="stage" style="margin-top:10px">
      <div class="flex" style="justify-content:space-between">
        <div class="badge">Dealer</div>
        <div class="badge">Balance: <b id="bjBal">$0</b></div>
      </div>

      <div class="hand" style="justify-content:center;align-items:center;margin-top:8px;gap:16px">
        <img id="dealerAvatar" style="width:56px;height:56px;border-radius:12px;border:1px solid rgba(255,255,255,.15);object-fit:cover">
        <div id="dealerHand" class="hand"></div>
        <span class="badge" id="dealerVal">â€”</span>
      </div>

      <div class="flex" style="justify-content:space-between;margin-top:8px">
        <div class="badge">Player: <b id="bjUser">â€”</b></div>
        <div class="badge" id="playerCardBadge">â€”</div>
      </div>

      <div class="hand" style="justify-content:center;align-items:flex-start;margin-top:6px;gap:16px">
        <div style="display:grid;justify-items:center;gap:6px">
          <img id="playerAvatar" style="width:56px;height:56px;border-radius:12px;border:1px solid rgba(255,255,255,.15);object-fit:cover">
          <div class="muted" id="playerNameUnder" style="font-size:.85rem"></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:10px">
          <div id="playerHand" class="hand" style="justify-content:center"></div>
          <div id="betTray" class="bet-tray"></div>
          <div class="flex" style="gap:8px;align-items:center">
            <span class="badge" id="betBadge">Bet: <b id="bjBet">$0</b></span>
            <span class="badge" id="playerVal">â€”</span>
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="btnDeal" class="accent">Deal</button>
        <button id="btnHit">Hit</button>
        <button id="btnStand">Stand</button>
        <button id="btnDouble">Double</button>
        <button id="btnNew" class="ghost">New Round</button>
      </div>

      <div class="rack" id="chipRack" style="margin-top:8px">
        <div class="chip-wrap"><button class="chip-emoji" data-val="10"  data-emoji="ðŸŸ¢" tabindex="0">ðŸŸ¢</button><div class="chip-label">$10</div></div>
        <div class="chip-wrap"><button class="chip-emoji" data-val="25"  data-emoji="ðŸ”µ" tabindex="0">ðŸ”µ</button><div class="chip-label">$25</div></div>
        <div class="chip-wrap"><button class="chip-emoji" data-val="50"  data-emoji="ðŸ”´" tabindex="0">ðŸ”´</button><div class="chip-label">$50</div></div>
        <div class="chip-wrap"><button class="chip-emoji" data-val="100" data-emoji="âš«" tabindex="0">âš«</button><div class="chip-label">$100</div></div>
        <div class="chip-wrap"><button class="chip-emoji" data-val="500" data-emoji="ðŸŸ£" tabindex="0">ðŸŸ£</button><div class="chip-label">$500</div></div>
        <div class="chip-wrap"><button class="chip-emoji" data-val="1000" data-emoji="ðŸŸ¡" tabindex="0">ðŸŸ¡</button><div class="chip-label">$1000</div></div>
      </div>

      <div class="controls" style="gap:10px;margin-top:8px">
        <button id="undoBet" class="ghost">Undo</button>
        <button id="clearBet" class="ghost">Clear bet</button>
      </div>
    </div>
  </section>

  <!-- 8-Ball Pool -->
  <section id="pool" class="stage hidden">
    <div class="pool-toolbar">
      <div class="flex" style="gap:10px">
        <button id="pFull" class="ghost">â¤¢ Fullscreen</button>
        <button id="pExit" class="ghost hidden">â¤¡ Exit</button>
        <button id="pRestart" class="accent">Restart</button>
        <select id="aiLevel">
          <option value="easy">AI: Easy</option>
          <option value="normal" selected>AI: Normal</option>
          <option value="hard">AI: Hard</option>
          <option value="pro">AI: Pro</option>
        </select>
        <button id="pHelp" class="ghost">How to play</button>
        <button class="ghost go" data-go="landing">Back</button>
      </div>
      <div class="badge" id="turnBadge">Your turn</div>
    </div>

    <div class="pool-outer" id="pOuter">
      <div class="pool-frame" id="pFrame">
        <canvas id="pCanvas" class="pool-canvas" width="1200" height="600"></canvas>
      </div>
      <div style="width:100%;max-width:1100px;margin-top:8px">
        <div class="powerbar"><span id="powerFill"></span></div>
      </div>
      <div class="rails" id="rails">
        <div class="hrail" id="railYou"><span class="title">You:</span></div>
        <div class="hrail" id="railAI"><span class="title">AI:</span></div>
      </div>
    </div>
  </section>
</main>

<!-- Help bubble -->
<div id="help" class="help-pop" aria-hidden="true">
  <div class="help-card" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <div class="help-close" id="helpX" aria-label="Close">âœ•</div>
    <h3 id="helpTitle">How to Play 8-Ball</h3>
    <ol>
      <li>Player breaks. First legally potted ball assigns groups: <b>solids</b> (1â€“7) or <b>stripes</b> (9â€“15).</li>
      <li>Drag from the cue ball to aim; pull back to set <b>power</b>; release to shoot.</li>
      <li>If no legal ball drops and the cue ball sinks, itâ€™s a <b>scratch</b> (ball-in-hand for opponent).</li>
      <li>Pocket the <b>8-ball</b> only after your group is cleared. Potting it early is a loss.</li>
      <li>AI difficulty changes aim error & power discipline.</li>
    </ol>
  </div>
</div>

<script>
/* ----------------- helpers & persistence ----------------- */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const store={k:'cosmic.games.v12',load(){try{return JSON.parse(localStorage.getItem(this.k))||{}}catch(e){return{}}},save(x){localStorage.setItem(this.k,JSON.stringify(x))}};
let state=Object.assign({user:'',bank:1000,selectedAvatar:0,selectedAvatarData:null,cardText:'â€”',cardColor:'#7aa2ff',mute:false},store.load());
function money(n){return '$'+n.toLocaleString()}
function show(id){ ['landing','customize','blackjack','pool'].forEach(n=>$('#'+n).classList.toggle('hidden',n!==id)); if(id==='pool') resizePool() }
function renderProfile(){ $('#username').value=state.user||''; $('#bal').textContent=money(state.bank); $('#bjBal').textContent=money(state.bank); $('#bjUser').textContent=state.user||'Player'; $('#playerNameUnder').textContent=state.user||'Player'; const card=$('#playerCardBadge'); card.textContent=state.cardText||'â€”'; card.style.color=state.cardColor; card.style.borderColor=state.cardColor; $('#muteBtn').textContent=state.mute?'ðŸ”‡':'ðŸ”Š'; }
$('#saveUser').onclick=()=>{state.user=($('#username').value||'').trim()||'Player'; store.save(state); renderProfile();}
$('#resetBank').onclick=()=>{if(confirm('Reset balance to $1,000?')){state.bank=1000;store.save(state);renderProfile();}}
$('#muteBtn').onclick=()=>{state.mute=!state.mute;store.save(state);renderProfile();}
$$('.go').forEach(b=>b.addEventListener('click',e=>{const id=e.currentTarget.dataset.go; if(id) show(id)}));
$('#openCustomize').addEventListener('click',()=>show('customize'));

/* ----------------- background stars + planets ----------------- */
(function(){
  const c=$('#bg'),x=c.getContext('2d'); let W,H,stars=[],planets=[];
  function R(){W=c.width=innerWidth;H=c.height=innerHeight;
    stars=Array.from({length:Math.min(1100,Math.floor(W*H/2200))},()=>({x:Math.random()*W,y:Math.random()*H,z:.2+.9*Math.random()}));
    planets=[{r:86,y:H*0.82,s:.07,base:'#2e73ff',rings:true,tilt:.45},{r:52,y:H*0.33,s:.11,base:'#ffb86b'},{r:36,y:H*0.58,s:.16,base:'#7afff2',rings:true,tilt:-.25}].map((p,i)=>Object.assign(p,{x:W+200+i*260,seed:Math.random()*1000}));
  } addEventListener('resize',R); R();
  function crater(gx,gy,r){x.beginPath();x.arc(gx,gy,r,0,6.28);x.fill();}
  (function loop(t){
    x.clearRect(0,0,W,H);
    x.fillStyle='#cfe7ff';
    stars.forEach(s=>{s.x-=s.z*.55; if(s.x<-2) s.x=W+2; x.globalAlpha=.5*s.z; x.fillRect(s.x,s.y,2*s.z,2*s.z);});
    x.globalAlpha=1;
    planets.forEach(p=>{
      p.x-=p.s*1.5; if(p.x<-p.r) p.x=W+p.r+220;
      let g=x.createRadialGradient(p.x-p.r*.35,p.y-p.r*.35,2,p.x,p.y,p.r);
      g.addColorStop(0,'#fff'); g.addColorStop(.12,p.base); g.addColorStop(1,'#0a0f2a');
      x.fillStyle=g; x.beginPath(); x.arc(p.x,p.y,p.r,0,6.28); x.fill();
      x.globalAlpha=.22; x.fillStyle='#000';
      for(let i=0;i<8;i++){let ang=(i*0.78+t*0.0002+p.seed)%6.28, rr=3+(i%3)*1.6; crater(p.x+Math.cos(ang)*p.r*.6,p.y+Math.sin(ang)*p.r*.45,rr);}
      x.globalAlpha=1;
      if(p.rings){ x.save(); x.translate(p.x,p.y); x.rotate(p.tilt||0); let rg=x.createRadialGradient(0,0, p.r*0.9, 0,0,p.r*1.25); rg.addColorStop(0,'rgba(255,255,255,.05)'); rg.addColorStop(1,'rgba(180,210,255,.18)'); x.fillStyle=rg; x.beginPath(); x.ellipse(0,0,p.r*1.35,p.r*.55,0,0,6.28); x.fill(); x.restore(); }
    });
    requestAnimationFrame(loop);
  })(0);
})();

/* ----------------- avatars ----------------- */
function svgData(svg){return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);}
const AVS=[
  svgData('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" rx="18" fill="#0b0e2b"/><circle cx="64" cy="64" r="44" fill="#0a0a0a"/><circle cx="64" cy="64" r="24" fill="#fff"/><text x="64" y="74" font-family="Arial Black,Arial" font-weight="900" font-size="28" text-anchor="middle" fill="#111">8</text></svg>'),
  svgData('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" rx="18" fill="#0b0e2b"/><rect x="20" y="12" width="88" height="104" rx="10" fill="#fff"/><text x="34" y="38" font-size="24" font-family="Georgia" fill="#b10c2b">K</text><text x="64" y="74" text-anchor="middle" font-size="64" font-family="Georgia" fill="#b10c2b">â™›</text></svg>'),
  svgData('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" rx="18" fill="#0b0e2b"/><rect x="20" y="12" width="88" height="104" rx="10" fill="#fff"/><text x="34" y="38" font-size="24" font-family="Georgia" fill="#b10c2b">Q</text><text x="64" y="74" text-anchor="middle" font-size="64" font-family="Georgia" fill="#b10c2b">â™¦</text></svg>'),
  svgData('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" rx="18" fill="#0b0e2b"/><rect x="20" y="12" width="88" height="104" rx="10" fill="#fff"/><text x="34" y="38" font-size="24" font-family="Georgia" fill="#111">J</text><text x="64" y="74" text-anchor="middle" font-size="64" font-family="Georgia" fill="#111">â™£</text></svg>'),
  svgData('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" rx="18" fill="#0b0e2b"/><circle cx="64" cy="52" r="28" fill="#9fd3ff"/><circle cx="64" cy="52" r="18" fill="#1f2a5f"/><rect x="28" y="84" width="72" height="24" rx="12" fill="#1f2a5f"/></svg>')
];
function mountLogo(){const l=$('#logo'); l.innerHTML=''; const i=new Image(); i.style.width='28px'; i.style.height='28px'; i.style.borderRadius='6px'; i.src=state.selectedAvatarData||AVS[state.selectedAvatar||0]; l.appendChild(i);}
(function(){
  const tabs=$$('.tab'); tabs.forEach(t=>t.onclick=()=>{tabs.forEach(a=>a.classList.remove('active')); t.classList.add('active'); ['tAv','tCard'].forEach(id=>$('#'+id).classList.toggle('hidden',id!==t.dataset.tab));});
  const g=$('#avatarGrid'); g.innerHTML='';
  AVS.forEach((src,i)=>{const d=document.createElement('div'); d.className='avatar'; if(i===(state.selectedAvatar||0)) d.classList.add('active'); const img=new Image(); img.src=src; img.style.width='64px'; img.style.height='64px'; d.appendChild(img); d.onclick=()=>{[].forEach.call(g.children,x=>x.classList.remove('active')); d.classList.add('active'); $('#avatarPreview').src=src; $('#avatarPreview').dataset.i=i;}; g.appendChild(d);});
  $('#avatarPreview').src=state.selectedAvatarData||AVS[state.selectedAvatar||0]; $('#avatarPreview').dataset.i=state.selectedAvatar||0;
  $('#cardText').value=state.cardText||'THE GOAT'; $('#cardColor').value=state.cardColor||'#7aa2ff';
  $('#saveAvatar').onclick=()=>{state.selectedAvatar=parseInt($('#avatarPreview').dataset.i||'0',10); state.selectedAvatarData=$('#avatarPreview').src; store.save(state); renderProfile(); mountLogo(); $('#playerAvatar').src=state.selectedAvatarData; alert('Avatar saved!');};
  $('#saveCard').onclick=()=>{state.cardText=$('#cardText').value||'â€”'; state.cardColor=$('#cardColor').value||'#7aa2ff'; store.save(state); renderProfile(); alert('Calling card saved!');};
})(); mountLogo(); renderProfile();

/* ----------------- Blackjack ----------------- */
(function(){
  const suits=['â™ ','â™¥','â™¦','â™£'], red={'â™¥':1,'â™¦':1};
  const ranks=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  let deck=[], dealer=[], player=[], hidden=true, dealing=false;

  /* bet state FIRST (avoid TDZ) */
  let stack=[]; const sumBet=()=>stack.reduce((s,n)=>s+n,0);
  const betLbl=$('#bjBet'), tray=$('#betTray'), msg=$('#bjMsg'), balLbl=$('#bjBal');
  const dealerHand=$('#dealerHand'), playerHand=$('#playerHand');
  const dealerVal=$('#dealerVal'), playerVal=$('#playerVal');
  const btnDeal=$('#btnDeal'), btnHit=$('#btnHit'), btnStand=$('#btnStand'), btnDouble=$('#btnDouble'), btnNew=$('#btnNew');
  const dealerAvatar=$('#dealerAvatar'), playerAvatar=$('#playerAvatar');
  const evil=svgData('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" rx="22" fill="#190c2f"/><circle cx="64" cy="64" r="46" fill="#5d1a8b"/><circle cx="46" cy="56" r="9" fill="#fff"/><circle cx="82" cy="56" r="9" fill="#fff"/><path d="M40 84c8 8 40 8 48 0" stroke="#fff" stroke-width="6" fill="none"/></svg>');
  dealerAvatar.src=evil; playerAvatar.src=state.selectedAvatarData||AVS[state.selectedAvatar||0];

  const AC=new (window.AudioContext||window.webkitAudioContext)();
  function beep(a){ if(state.mute) return; let t=AC.currentTime; a.forEach(s=>{const o=AC.createOscillator(),g=AC.createGain();o.type=s.type||'sine';o.frequency.value=s.f;g.gain.setValueAtTime(.0001,t);g.gain.exponentialRampToValueAtTime(.2,t+.01);g.gain.exponentialRampToValueAtTime(.0001,t+s.d/1000);o.connect(g).connect(AC.destination);o.start(t);o.stop(t+s.d/1000);t+=s.d/1000+.02;});}
  const sfx={bj(){beep([{f:880,d:120},{f:1320,d:140},{f:1760,d:160,type:'triangle'}])},lose(){beep([{f:330,d:180},{f:246,d:220,type:'saw'}])},win(){beep([{f:392,d:90},{f:523,d:90},{f:659,d:140,type:'square'}])},deal(){beep([{f:320,d:25,type:'square'}])}};

  function buildDeck(){ deck=[]; for(let s=0;s<4;s++) for(let r=0;r<13;r++) deck.push({s:suits[s],r:ranks[r]}); for(let i=deck.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]];}}
  const cardVal=c=>c.r==='A'?11:(c.r==='K'||c.r==='Q'||c.r==='J'?10:+c.r);
  function handVal(a){ let t=a.reduce((s,c)=>s+cardVal(c),0), ac=a.filter(c=>c.r==='A').length; while(t>21&&ac--) t-=10; return t; }
  function renderHand(el,arr,hideFirst){ el.innerHTML=''; arr.forEach((c,i)=>{const d=document.createElement('div'); if(hideFirst&&i===0){d.className='card back'; el.appendChild(d); return;} d.className='card '+(red[c.s]?'red':'black'); const t=document.createElement('div'); t.className='rank'; t.textContent=c.r; const s=document.createElement('div'); s.className='suit'; s.textContent=c.s; const p=document.createElement('div'); p.className='pips'; p.textContent=c.s; d.append(t,s,p); el.appendChild(d); requestAnimationFrame(()=>{d.classList.add('deal-in','flip-in')});});}
  function setMsg(t,cls){msg.className='banner'+(cls?(' '+cls):''); msg.textContent=t;}
  function ensureDeck(){if(deck.length<15) buildDeck();}
  const wait=ms=>new Promise(r=>setTimeout(r,ms));
  function refreshBet(){ betLbl.textContent=money(sumBet()); }
  function clearBet(){ stack.length=0; tray.innerHTML=''; refreshBet(); }

  function reset(){ dealer=[]; player=[]; hidden=true; dealing=false; renderHand(dealerHand,dealer,false); renderHand(playerHand,player,false); dealerVal.textContent='â€”'; playerVal.textContent='â€”'; setMsg('Select a bet first.'); btnHit.disabled=btnStand.disabled=btnDouble.disabled=true; btnDeal.disabled=false; btnNew.disabled=true; clearBet(); dealerAvatar.src=evil; playerAvatar.src=state.selectedAvatarData||AVS[state.selectedAvatar||0]; }
  buildDeck(); reset();

  // chips: stronger debounce
  function addChip(v,e){const t=document.createElement('div'); t.className='bet-token'; t.dataset.val=v; t.dataset.label=money(v); t.textContent=e; t.onclick=()=>{const i=stack.lastIndexOf(v); if(i>-1) stack.splice(i,1); t.remove(); refreshBet();}; tray.appendChild(t); stack.push(v); refreshBet();}
  let clickLock=false;
  $('#chipRack').addEventListener('click',e=>{const b=e.target.closest('.chip-emoji'); if(!b||clickLock) return; clickLock=true; setTimeout(()=>clickLock=false,380); addChip(+b.dataset.val,b.dataset.emoji);});
  $('#undoBet').onclick=()=>{if(!stack.length) return; const v=stack.pop(); const list=tray.children; for(let i=list.length-1;i>=0;i--){if(+list[i].dataset.val===v){list[i].remove();break;}} refreshBet();}
  $('#clearBet').onclick=clearBet;

  async function dealSeq(){dealing=true;
    player.push(deck.pop()); sfx.deal(); renderHand(playerHand,player,false); upd(); await wait(260);
    dealer.push(deck.pop()); sfx.deal(); renderHand(dealerHand,dealer,true);  upd(); await wait(260);
    player.push(deck.pop()); sfx.deal(); renderHand(playerHand,player,false); upd(); await wait(260);
    dealer.push(deck.pop()); sfx.deal(); renderHand(dealerHand,dealer,true);  upd(); dealing=false;
  }
  function upd(){ playerVal.textContent=handVal(player); dealerVal.textContent=hidden?'??':handVal(dealer); }

  btnDeal.onclick=async function(){
    const bet=sumBet(); if(bet<=0){setMsg('Select chips first (you can mix).');return;} if(state.bank<bet){setMsg('Insufficient balance.','lose');return;}
    ensureDeck(); dealer=[]; player=[]; hidden=true; state.bank-=bet; store.save(state); renderProfile(); balLbl.textContent=money(state.bank);
    renderHand(dealerHand,dealer,true); renderHand(playerHand,player,false); btnDeal.disabled=true; btnNew.disabled=true; setMsg('Dealing...'); await dealSeq();
    const pv=handVal(player); upd();
    if(pv===21){ hidden=false; renderHand(dealerHand,dealer,false); upd(); const dv=handVal(dealer);
      if(dv===21){ setMsg('Push. Blackjack vs Blackjack.'); state.bank+=bet; }
      else{ state.bank+=Math.floor(bet*1.5)+bet; setMsg('Blackjack! Paid 3:2','win'); sfx.bj(); }
      store.save(state); renderProfile(); btnNew.disabled=false; clearBet(); return;
    }
    setMsg('Your move.'); btnHit.disabled=btnStand.disabled=btnDouble.disabled=false;
  };
  btnHit.onclick=async function(){ if(dealing) return; ensureDeck(); dealing=true; player.push(deck.pop()); sfx.deal(); renderHand(playerHand,player,false); upd(); await wait(260); dealing=false;
    const v=handVal(player); if(v===21){ hidden=false; renderHand(dealerHand,dealer,false); upd(); state.bank+=sumBet()*2; setMsg('21! You win instantly.','win'); sfx.win(); store.save(state); renderProfile(); btnHit.disabled=btnStand.disabled=btnDouble.disabled=true; btnNew.disabled=false; clearBet(); return;}
    if(v>21){ hidden=false; renderHand(dealerHand,dealer,false); upd(); setMsg('Busted. Dealer wins.','lose'); sfx.lose(); btnHit.disabled=btnStand.disabled=btnDouble.disabled=true; btnNew.disabled=false; clearBet();}
  };
  btnStand.onclick=async function(){ btnHit.disabled=btnStand.disabled=btnDouble.disabled=true; hidden=false; renderHand(dealerHand,dealer,false); upd();
    while(handVal(dealer)<17){ ensureDeck(); dealing=true; dealer.push(deck.pop()); sfx.deal(); renderHand(dealerHand,dealer,false); upd(); await wait(300); } const bet=sumBet(), p=handVal(player), d=handVal(dealer);
    if(d>21||p>d){ state.bank+=bet*2; setMsg('You win!','win'); sfx.win(); }
    else if(p===d){ state.bank+=bet; setMsg('Push.'); }
    else{ setMsg('Dealer wins.','lose'); sfx.lose(); }
    store.save(state); renderProfile(); btnNew.disabled=false; clearBet();
  };
  btnDouble.onclick=function(){ const bet=sumBet(); if(state.bank<bet){setMsg('Not enough balance to double.','lose');return;}
    [...tray.children].forEach(t=>{const v=+t.dataset.val, e=t.textContent; const dup=document.createElement('div'); dup.className='bet-token'; dup.dataset.val=v; dup.dataset.label=money(v); dup.textContent=e; dup.onclick=()=>{const i=stack.lastIndexOf(v); if(i>-1) stack.splice(i,1); dup.remove(); refreshBet();}; tray.appendChild(dup); stack.push(v); });
    state.bank-=bet; store.save(state); renderProfile(); refreshBet(); btnHit.click();
  };
  btnNew.onclick=reset;

  // fullscreen
  const bjFs=$('#bjFull'), bjExit=$('#bjExit'), table=$('#blackjack');
  const inFs=()=>document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement;
  const reqFs=el=>el.requestFullscreen?el.requestFullscreen():el.webkitRequestFullscreen?el.webkitRequestFullscreen():el.msRequestFullscreen&&el.msRequestFullscreen();
  const exitFs=_=>document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen();
  function ch(){const is=inFs(); bjFs.classList.toggle('hidden',is); bjExit.classList.toggle('hidden',!is); document.body.classList.toggle('fs-bj',is);}
  document.addEventListener('fullscreenchange',ch); document.addEventListener('webkitfullscreenchange',ch); document.addEventListener('MSFullscreenChange',ch);
  bjFs.onclick=()=>reqFs(table); bjExit.onclick=()=>exitFs();
})();

/* ----------------- 8-Ball Pool with AI ----------------- */
(function(){
  const cvs=$('#pCanvas'), ctx=cvs.getContext('2d'), outer=$('#pOuter'), frame=$('#pFrame');
  const fsIn=$('#pFull'), fsOut=$('#pExit'), restart=$('#pRestart'), levelSel=$('#aiLevel');
  const powerFill=$('#powerFill'); const badge=$('#turnBadge');
  const help=$('#help'), helpBtn=$('#pHelp'), helpX=$('#helpX');
  const railYou=$('#railYou'), railAI=$('#railAI');

  // sizes
  let W=cvs.width, H=cvs.height, R=11, FRICTION=0.992, REST=0.02, POCKET=20, rail=18;

  // state
  let balls=[], pockets=[], power=0, pulling=false, aimStart=null, mouse={x:W/2,y:H/2};
  let turn='player', groups={player:null, ai:null}, rails={player:[], ai:[]}, needAssign=true, ballInHand=false;

  const COLORS={1:'#f94144',2:'#f3722c',3:'#f8961e',4:'#f9844a',5:'#f9c74f',6:'#90be6d',7:'#43aa8b',8:'#000',9:'#f94144',10:'#f3722c',11:'#f8961e',12:'#f9844a',13:'#f9c74f',14:'#90be6d',15:'#43aa8b'};
  const aiLevels={easy:{aimErr:.18,powVar:.40,greedy:.3}, normal:{aimErr:.10,powVar:.22,greedy:.55}, hard:{aimErr:.05,powVar:.14,greedy:.8}, pro:{aimErr:.02,powVar:.08,greedy:.95}};

  function setTurn(t){turn=t; badge.textContent=(t==='player'?'Your turn':'AI turn');}
  function newBall(x,y,color,id,type){return {x,y,vx:0,vy:0,r:R,color,id:id||0,type:type||'neutral',in:false};}
  function typeOf(n){return n===8?'eight':(n<=7?'solid':'stripe')}
  function cue(){return balls[0]}

  function rack(){
    balls=[]; balls.push(newBall(W*0.25,H*0.5,'#ffffff',0,'cue'));
    const order=[1,10,2,8,3,11,4,12,5,13,6,14,7,15,9];
    let cx=W*0.66, cy=H*0.5, idx=0;
    for(let r=0;r<5;r++) for(let c=0;c<=r;c++){const x=cx+r*(R*2-1), y=cy-(r*R)+c*R*2; const n=order[idx++]; balls.push(newBall(x,y,COLORS[n],n,typeOf(n)));}
    pockets=[{x:rail,y:rail},{x:W/2,y:rail-6},{x:W-rail,y:rail},{x:rail,y:H-rail},{x:W/2,y:H-rail+6},{x:W-rail,y:H-rail}];
    groups.player=null; groups.ai=null; rails.player=[]; rails.ai=[]; needAssign=true; setTurn('player'); ballInHand=false; renderRails();
  }

  function renderRails(){
    const mk=(arr,color)=>arr.map(n=>`<span class="balldot" style="background:${colorOf(n)}"></span>`).join('');
    railYou.querySelectorAll('.title')[0] || railYou.prepend(document.createElement('span')).classList?.add('title');
    railAI.querySelectorAll('.title')[0] || railAI.prepend(document.createElement('span')).classList?.add('title');
    railYou.querySelector('.title').innerHTML = `You: ${groups.player?('<b>'+(groups.player==='solid'?'Solids':'Stripes')+'</b>'):'â€”'}`;
    railAI.querySelector('.title').innerHTML  = `AI: ${groups.ai?('<b>'+(groups.ai==='solid'?'Solids':'Stripes')+'</b>'):'â€”'}`;
    railYou.innerHTML = `<span class="title">${railYou.querySelector('.title').innerHTML}</span>` + mk(rails.player, '#fff');
    railAI.innerHTML  = `<span class="title">${railAI.querySelector('.title').innerHTML}</span>` + mk(rails.ai, '#fff');
  }
  const colorOf=n=>COLORS[n]||'#fff';

  // drawing
  function drawTable(){
    ctx.clearRect(0,0,W,H);
    let g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#0d3a38'); g.addColorStop(1,'#082725'); ctx.fillStyle=g; ctx.fillRect(rail,rail,W-rail*2,H-rail*2);
    ctx.lineWidth=rail; ctx.strokeStyle='#213245'; ctx.strokeRect(rail/2,rail/2,W-rail,H-rail);
    ctx.fillStyle='#a7c4ff55'; for(let i=1;i<6;i++){ctx.fillRect(rail+(W-2*rail)*i/6-2,rail-6,4,12); ctx.fillRect(rail+(W-2*rail)*i/6-2,H-6,4,12);}
    for(const p of pockets){ctx.beginPath(); ctx.arc(p.x,p.y,POCKET,0,Math.PI*2); ctx.fillStyle='#0a0a0a'; ctx.fill();}
  }
  function drawBalls(){
    balls.forEach(b=>{ if(b.in) return; const sh=ctx.createRadialGradient(b.x-b.r*0.4,b.y-b.r*0.4,b.r*0.2,b.x,b.y,b.r); sh.addColorStop(0,'#fff'); sh.addColorStop(.2,b.color); sh.addColorStop(1,b.color); ctx.fillStyle=sh; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); if(b.type==='stripe'){ ctx.fillStyle='#fff'; ctx.fillRect(b.x-b.r,b.y-4,b.r*2,8);} if(b.id===8){ ctx.fillStyle='#111'; ctx.beginPath(); ctx.arc(b.x,b.y,6,0,6.28); ctx.fill(); ctx.fillStyle='#fff'; ctx.font='9px Arial Black'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('8',b.x,b.y+.2);} });
  }

  // physics
  function physics(){
    balls.forEach(b=>{ if(b.in) return; b.x+=b.vx; b.y+=b.vy; b.vx*=FRICTION; b.vy*=FRICTION; if(Math.abs(b.vx)<REST) b.vx=0; if(Math.abs(b.vy)<REST) b.vy=0; });
    balls.forEach(b=>{ if(b.in) return; if(b.x-b.r<rail){b.x=rail+b.r;b.vx=Math.abs(b.vx);} if(b.x+b.r>W-rail){b.x=W-rail-b.r;b.vx=-Math.abs(b.vx);} if(b.y-b.r<rail){b.y=rail+b.r;b.vy=Math.abs(b.vy);} if(b.y+b.r>H-rail){b.y=H-rail-b.r;b.vy=-Math.abs(b.vy);} });
    for(let i=0;i<balls.length;i++) for(let j=i+1;j<balls.length;j++){ const a=balls[i], b=balls[j]; if(a.in||b.in) continue; const dx=b.x-a.x, dy=b.y-a.y, d=Math.hypot(dx,dy), m=a.r+b.r; if(d>0&&d<m){ const nx=dx/d, ny=dy/d, p=(a.vx*nx+a.vy*ny)-(b.vx*nx+b.vy*ny); if(p>0){ a.vx-=p*nx; a.vy-=p*ny; b.vx+=p*nx; b.vy+=p*ny; } const ov=m-d; a.x-=nx*ov/2; a.y-=ny*ov/2; b.x+=nx*ov/2; b.y+=ny*ov/2; } }
    const potted=[]; balls.forEach(b=>{ if(b.in) return; for(const p of pockets){ if(Math.hypot(b.x-p.x,b.y-p.y)<POCKET-3){ b.in=true;b.vx=b.vy=0;potted.push(b);break; } }});
    if(!potted.length) return;
    let legal=false, scratched=false, eight=false;
    potted.forEach(b=>{
      if(b.type==='cue'){ scratched=true; b.in=false; ballInHand=true; b.x=W*0.25; b.y=H*0.5; b.vx=b.vy=0; }
      else if(b.type==='eight'){ eight=true; }
      else{
        if(needAssign){
          if(turn==='player'){ groups.player=b.type; groups.ai=(b.type==='solid')?'stripe':'solid'; needAssign=false; }
          else { groups.ai=b.type; groups.player=(b.type==='solid')?'stripe':'solid'; needAssign=false; }
        }
        if((turn==='player'&&b.type===groups.player)||(turn==='ai'&&b.type===groups.ai)){ legal=true; (turn==='player'?rails.player:rails.ai).push(b.id); }
        else (turn==='player'?rails.ai:rails.player).push(b.id);
      }
    });
    renderRails();

    if(eight){
      const need = balls.some(x=>!x.in && (x.type==='solid'||x.type==='stripe') && ((turn==='player' && x.type===groups.player) || (turn==='ai' && x.type===groups.ai)));
      badge.textContent = need ? (turn==='player'?'AI wins (early 8)':'You win (early 8 by AI)') : (turn==='player'?'You win!':'AI wins!');
      setTimeout(()=>rack(),1600); return;
    }
    if(!(legal && !scratched)) setTurn(turn==='player'?'ai':'player');
  }
  const rolling=()=>balls.some(b=>!b.in&&(Math.abs(b.vx)>REST||Math.abs(b.vy)>REST));

  // input
  cvs.addEventListener('mousemove',e=>{const r=cvs.getBoundingClientRect(); mouse.x=(e.clientX-r.left)*cvs.width/r.width; mouse.y=(e.clientY-r.top)*cvs.height/r.height; if(pulling){ power=Math.min(100, Math.hypot(mouse.x-aimStart.x, mouse.y-aimStart.y)/2); powerFill.style.width=power+'%'; }});
  cvs.addEventListener('mousedown',e=>{
    if(turn!=='player'||rolling()) return;
    if(ballInHand){ // place cue ball
      const cb=cue(); const r=cvs.getBoundingClientRect(); const x=(e.clientX-r.left)*cvs.width/r.width, y=(e.clientY-r.top)*cvs.height/r.height;
      if(x>rail+R && x<W-rail-R && y>rail+R && y<H-rail-R){ cb.x=x; cb.y=y; ballInHand=false; }
      return;
    }
    const cb=cue(); pulling=true; aimStart={x:cb.x,y:cb.y}; power=0; powerFill.style.width='0%';
  });
  cvs.addEventListener('mouseup',e=>{
    if(turn!=='player' || !pulling) return; pulling=false; const cb=cue(); const dx=cb.x-mouse.x, dy=cb.y-mouse.y; const len=Math.hypot(dx,dy)||1; const force=(power/8); if(force<.2) return; cb.vx+=(dx/len)*force; cb.vy+=(dy/len)*force; power=0; powerFill.style.width='0%';
  });

  // AI
  function lineBlocked(ax,ay,bx,by,ignore){ // simple circle-line test vs balls
    for(const o of balls){ if(o.in||o===ignore) continue; const vx=bx-ax, vy=by-ay; const wx=o.x-ax, wy=o.y-ay; const t=Math.max(0,Math.min(1,(wx*vx+wy*vy)/(vx*vx+vy*vy))); const px=ax+t*vx, py=ay+t*vy; if(Math.hypot(o.x-px,o.y-py) < o.r*1.08) return true; }
    return false;
  }
  function aiShoot(){
    const cb=cue(); const lvl=aiLevels[levelSel.value];
    // candidate shots
    let targets=balls.filter(b=>!b.in && b.type!=='cue' && (groups.ai? (b.type===groups.ai||b.type==='eight'):b.type!=='eight'));
    if(!targets.length) targets=balls.filter(b=>!b.in && b.type==='eight');
    let best=null, bestScore=-1;
    for(const b of targets){
      for(const p of pockets){
        // ghost-ball position for straight-in
        const dx=p.x-b.x, dy=p.y-b.y, d=Math.hypot(dx,dy)||1;
        const gx=b.x-dx/d*b.r*2, gy=b.y-dy/d*b.r*2;
        if(lineBlocked(gx,gy,p.x,p.y,b)) continue;
        if(lineBlocked(cb.x,cb.y,gx,gy,b)) continue;
        const cut=Math.abs(Math.atan2(dy,dx)); // rough difficulty
        const dist=Math.hypot(cb.x-gx,cb.y-gy);
        let score=1000 - dist - cut*120;
        if(b.type==='eight' && (rails.ai.length<7)) score-=400; // avoid early 8
        if(score>bestScore){ bestScore=score; best={b,p,gx,gy}; }
      }
    }
    if(!best){ // safety: bump towards rail
      const ang=Math.random()*6.28; const pow=0.8; cb.vx=Math.cos(ang)*pow; cb.vy=Math.sin(ang)*pow; return;
    }
    // aim noise & power discipline
    const n=lvl.aimErr, rnd=()=> (Math.random()*2-1)*n*120;
    const tx=best.gx+rnd(), ty=best.gy+rnd();
    const dx=tx-cb.x, dy=ty-cb.y, len=Math.hypot(dx,dy)||1;
    let pow = Math.min(1.2, Math.max(.35, (Math.hypot(best.gx-best.b.x,best.gy-best.b.y)/160) + (Math.random()*lvl.powVar)));
    cb.vx=(dx/len)*pow*2.2; cb.vy=(dy/len)*pow*2.2;
  }

  // loop
  (function loop(){
    drawTable(); drawBalls();
    if(turn==='player' && !rolling()){
      const cb=cue(); // draw cue + short tip
      const dx=mouse.x-cb.x, dy=mouse.y-cb.y, ang=Math.atan2(dy,dx), tipX=cb.x+Math.cos(ang)*cb.r, tipY=cb.y+Math.sin(ang)*cb.r, len=160+power*2;
      ctx.lineWidth=8; ctx.strokeStyle='#a67c52'; ctx.beginPath(); ctx.moveTo(tipX-Math.cos(ang)*len, tipY-Math.sin(ang)*len); ctx.lineTo(tipX,tipY); ctx.stroke();
      ctx.lineWidth=10; ctx.strokeStyle='#2a7bd3cc'; ctx.beginPath(); ctx.moveTo(tipX,tipY); ctx.lineTo(tipX+Math.cos(ang)*8, tipY+Math.sin(ang)*8); ctx.stroke();
    }
    physics();
    if(!rolling() && turn==='ai' && !ballInHand){ aiShoot(); setTurn('player'); }
    requestAnimationFrame(loop);
  })();

  restart.onclick=()=>rack();

  // fullscreen
  const inFs=()=>document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement;
  const reqFs=el=>el.requestFullscreen?el.requestFullscreen():el.webkitRequestFullscreen?el.webkitRequestFullscreen():el.msRequestFullscreen&&el.msRequestFullscreen();
  const exitFs=_=>document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen();
  function ch(){const is=inFs(); fsIn.classList.toggle('hidden',is); fsOut.classList.toggle('hidden',!is); frame.style.maxWidth=is?'96vw':'1100px';}
  document.addEventListener('fullscreenchange',ch); document.addEventListener('webkitfullscreenchange',ch); document.addEventListener('MSFullscreenChange',ch);
  fsIn.onclick=()=>reqFs(outer); fsOut.onclick=()=>exitFs();

  function resize(){ /* keep aspect, center */ }
  function resizePool(){ /* placeholder for future responsive calc */ }
  rack();

  // Help bubble
  function openHelp(){ help.style.display='flex'; help.setAttribute('aria-hidden','false'); helpX.focus(); }
  function closeHelp(){ help.style.display='none'; help.setAttribute('aria-hidden','true'); }
  helpBtn.onclick=openHelp; helpX.onclick=closeHelp;
  help.addEventListener('click',e=>{ if(e.target===help) closeHelp(); });
  addEventListener('keydown',e=>{ if(e.key==='Escape') closeHelp(); });

  // initial rails render
  renderRails();
})();

/* ---------- boot ---------- */
renderProfile();
</script>
</body>
</html>
