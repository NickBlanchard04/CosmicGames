<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cosmic Games</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    :root{
      --bg-deep:#070814;
      --bg-card:#0e1030;
      --bg-panel:#0b0d24;
      --ink:#dfe7ff;
      --ink-dim:#a7b0d9;
      --accent:#7aa2ff;
      --accent-2:#8ef5ff;
      --win:#43f57a;
      --lose:#ff6b6b;
      --warn:#ffd166;
      --table:#0a2a2a; /* blackjack felt */
      --chip:#2dd4bf;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg-deep);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    a{color:var(--accent)}
    button{background:#1a1e4d;color:var(--ink);border:1px solid #2a3180;border-radius:10px;padding:.7rem 1rem;font-weight:600;cursor:pointer;transition:.15s}
    button:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(122,162,255,.12)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:transparent;border:1px solid #2a3180}
    .accent{background:linear-gradient(180deg,#3242a8,#1e2a8a);border-color:#4656cc}
    input,select{background:#0c1033;border:1px solid #2a3180;color:var(--ink);padding:.6rem .8rem;border-radius:10px}
    /* Layout */
    .app{position:relative;min-height:100%;overflow:hidden}
    /* Animated starfield canvas backdrop */
    #starfield,#nebula{
      position:fixed;inset:0;z-index:0;display:block;pointer-events:none
    }
    #nebula{filter:blur(40px);opacity:.55;mix-blend-mode:screen}
    /* Top bar */
    .topbar{
      position:relative;z-index:2;display:flex;gap:1rem;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(180deg,rgba(10,12,32,.85),rgba(10,12,32,.55));
      border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:saturate(140%) blur(8px)
    }
    .brand{display:flex;gap:.7rem;align-items:center;font-weight:800;letter-spacing:.8px}
    .brand .logo{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:radial-gradient(circle at 30% 30%,#8ef5ff,transparent 45%),radial-gradient(circle at 70% 70%,#7aa2ff,transparent 45%),#141a44;box-shadow:0 0 20px #7aa2ff50 inset,0 0 0 1px #334}
    .pill{display:inline-flex;gap:.5rem;align-items:center;padding:.4rem .7rem;border:1px solid #2a3180;border-radius:999px;background:#0c1033}
    /* Main grid */
    .grid{position:relative;z-index:1;display:grid;grid-template-columns:320px 1fr;gap:18px;max-width:1300px;margin:18px auto;padding:0 18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{background:linear-gradient(180deg,rgba(12,16,51,.95),rgba(7,8,20,.96));border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(10,12,30,.35)}
    /* Sidebar */
    .sidebar h3{margin:8px 0 12px;font-size:14px;color:var(--ink-dim);text-transform:uppercase;letter-spacing:1.2px}
    .game-list{display:grid;gap:10px}
    .game-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;cursor:pointer;border:1px solid rgba(255,255,255,.06);background:#0b0e2b}
    .game-item:hover{background:#0f133a}
    .game-item .icon{font-size:20px}
    .active{outline:2px solid #3751ff}
    /* Stage */
    .stage{min-height:540px;display:grid;grid-template-rows:auto 1fr}
    .stage-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .stage-viewport{position:relative;border-radius:14px;border:1px solid rgba(255,255,255,.06);background:radial-gradient(1200px 600px at 40% 30%,#0c133f 0%,#070814 60%)}
    .stage-inner{padding:16px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .wrap{flex-wrap:wrap}
    .spacer{flex:1}
    .muted{color:var(--ink-dim)}
    .badge{padding:.2rem .5rem;background:#1a1e4d;border:1px solid #2a3180;border-radius:999px;font-size:.8rem}
    /* Reusable canvases */
    canvas.game-canvas{display:block;width:100%;max-width:900px;height:540px;background:#090b1f;border-radius:12px;margin:auto}
    /* Simple tables */
    table{width:100%;border-collapse:collapse}
    td,th{padding:8px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    /* Blackjack visuals */
    .bj-wrap{display:grid;gap:12px;padding:12px}
    .bj-table{
      position:relative;border-radius:16px;border:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(122,162,255,.15), transparent 60%),
        radial-gradient(1200px 600px at 80% 90%, rgba(142,245,255,.12), transparent 60%),
        radial-gradient(600px 300px at 50% 0%, rgba(255,255,255,.05), transparent 60%),
        var(--table);
      padding:18px;min-height:420px;display:grid;grid-template-rows:auto 1fr auto;gap:10px
    }
    .chip{display:inline-grid;place-items:center;width:42px;height:42px;border-radius:999px;font-weight:800;border:3px solid white;box-shadow:0 4px 0 rgba(0,0,0,.25) inset,0 0 0 2px #0b102a}
    .chip span{font-size:11px}
    .chip-blue{background:#3b82f6}
    .chip-green{background:#22c55e}
    .chip-red{background:#ef4444}
    .chip-black{background:#111827;color:#fff}
    .chip-purple{background:#a855f7}
    .chip-yellow{background:#eab308}
    .rack{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .hand{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .card{width:74px;height:104px;border-radius:10px;background:#f4f7ff;border:1px solid #ccd5ff;box-shadow:0 6px 18px rgba(0,0,0,.25);display:grid;grid-template-rows:auto 1fr auto;overflow:hidden;position:relative}
    .card .rank{font-weight:900;font-size:18px;padding:6px 8px}
    .card .suit{font-size:20px;padding:0 8px}
    .card .pips{display:grid;place-items:center;font-size:28px;color:#111;margin-bottom:6px}
    .card.red{color:#b10c2b}
    .card.black{color:#111}
    .card.back{background:repeating-linear-gradient(45deg,#102255 0 8px,#0c1a44 8px 16px),radial-gradient(600px 600px at 10% 10%, rgba(255,255,255,.08), transparent 60%);border-color:#20337a}
    .banner{display:flex;align-items:center;justify-content:center;gap:.6rem;padding:.4rem .8rem;border-radius:999px;background:#0e153f;border:1px solid #2a3180}
    .banner.win{color:var(--win);border-color:#2f6f4f;background:#0b2e1a}
    .banner.lose{color:var(--lose);border-color:#6f2f2f;background:#2e0b0b}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    /* Customize avatars */
    .avatar-tile{width:92px;height:92px;border-radius:14px;border:2px solid transparent;cursor:pointer;background:#0b0e2b;display:grid;place-items:center;overflow:hidden}
    .avatar-tile img{width:100%;height:100%;object-fit:cover}
    .avatar-tile.active{border-color:#7aa2ff;box-shadow:0 0 0 3px rgba(122,162,255,.25)}
    /* Footer */
    .foot{opacity:.8;text-align:center;padding:10px}
    /* Tiny HUD tags */
    .kv{display:inline-flex;gap:.4rem;align-items:center;padding:.35rem .6rem;border-radius:10px;background:#10133a;border:1px solid rgba(255,255,255,.08);font-size:.9rem}
  </style>
</head>
<body>
<div class="app">
  <canvas id="nebula"></canvas>
  <canvas id="starfield"></canvas>

  <div class="topbar">
    <div class="brand">
      <div class="logo">‚òÖ</div>
      <div>Cosmic Games</div>
    </div>
    <div class="flex wrap">
      <div class="pill">
        <span>üë§</span>
        <input id="username" placeholder="Enter username" style="width:180px" />
        <button id="saveUser" class="ghost">Save</button>
      </div>
      <div class="pill"><span>üí∞</span> <span>Balance:</span> <strong id="bal">$0</strong></div>
      <button id="openHelp" class="accent">Help</button>
    </div>
  </div>

  <div class="grid">
    <!-- Sidebar -->
    <aside class="panel sidebar">
      <h3>Games</h3>
      <div class="game-list" id="gameList">
        <div class="game-item active" data-game="landing"><div class="icon">üèÅ</div><div>Landing</div></div>
        <div class="game-item" data-game="customize"><div class="icon">üé®</div><div>Customize</div></div>
        <div class="game-item" data-game="shooter"><div class="icon">üöÄ</div><div>Astro Shooter</div></div>
        <div class="game-item" data-game="blackjack"><div class="icon">üÉè</div><div>Blackjack</div></div>
        <div class="game-item" data-game="tictactoe"><div class="icon">‚ùå‚≠ï</div><div>Cosmic Tic‚ÄëTac‚ÄëToe</div></div>
        <div class="game-item" data-game="snake"><div class="icon">ü™±</div><div>Orbital Snake</div></div>
        <div class="game-item" data-game="memory"><div class="icon">üß†</div><div>Meteor Match</div></div>
      </div>
      <h3>Stats</h3>
      <div class="panel" style="padding:12px;background:#0a0d2a">
        <div class="flex"><span class="kv">üëæ Shooter high: <b id="hiShooter">0</b></span></div>
        <div class="flex"><span class="kv">üÉè BJ bankroll best: <b id="hiBankroll">$0</b></span></div>
        <div class="flex"><span class="kv">ü™± Snake length best: <b id="hiSnake">0</b></span></div>
        <div class="flex"><span class="kv">‚≠ï Tic‚ÄëTac‚ÄëToe wins: <b id="tttWins">0</b></span></div>
        <div class="flex"><span class="kv">üß† Fastest match: <b id="memBest">‚Äî</b></span></div>
      </div>
    </aside>

    <!-- Stage -->
    <main class="panel stage">
      <div class="stage-header">
        <div class="flex">
          <div class="badge">üåå Space Edition</div>
          <div class="muted">Animated starfield ‚Ä¢ Drifting nebula ‚Ä¢ Saved progress</div>
        </div>
        <div class="flex">
          <button id="btnSound" class="ghost">üîä Sound On</button>
        </div>
      </div>
      <div class="stage-viewport" id="stage">
        <!-- Landing -->
        <section class="stage-inner" id="landing">
          <h1 style="margin:6px 0 4px">Welcome to <span style="color:var(--accent)">Cosmic Games</span> ‚ú®</h1>
          <p class="muted">Choose a game on the left. Your username, balance, and highscores are saved locally.</p>
          <div class="panel" style="margin-top:12px">
            <h3>Quick Start</h3>
            <ol>
              <li>Set your username (top right) ‚Äî you‚Äôll start with $1,000 credits.</li>
              <li>Click a game in the sidebar.</li>
              <li>For <b>Astro Shooter</b>: use <b>‚Üê ‚Üí</b> to move, <b>Space</b> to fire, survive waves to reach the planet.</li>
              <li>For <b>Blackjack</b>: place a bet with chips, then Hit/Stand. Standard 52‚Äëcard shoe, reshuffles as needed.</li>
            </ol>
          </div>
        </section>

        <!-- Customize -->
        <section class="stage-inner" id="customize" style="display:none">
          <h2 style="margin:0 0 8px">Customize</h2>
          <div class="panel" style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
            <div>
              <div class="muted" style="margin-bottom:6px">Your avatar</div>
              <img id="avatarPreview" alt="avatar" style="width:96px;height:96px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:#0c1033;object-fit:cover" />
            </div>
            <button id="saveAvatar" class="accent">Save Selection</button>
          </div>
          <div class="muted" style="margin:12px 0 8px">Choose an avatar:</div>
          <div id="avatarGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(92px,1fr));gap:12px"></div>
        </section>

        <!-- Astro Shooter -->
        <section class="stage-inner" id="shooter" style="display:none">
          <div class="flex" style="margin-bottom:8px">
            <div class="badge">üéÆ Controls: ‚Üê ‚Üí move ‚Ä¢ Space shoot ‚Ä¢ P pause</div>
            <div class="spacer"></div>
            <button id="shooterStart" class="accent">Start / Restart</button>
            <span class="kv">Level: <b id="lvl">1</b></span>
            <span class="kv">Score: <b id="score">0</b></span>
            <span class="kv">Lives: <b id="lives">3</b></span>
          </div>
          <canvas id="shooterCanvas" class="game-canvas" width="900" height="540"></canvas>
        </section>

        <!-- Blackjack -->
        <section class="stage-inner" id="blackjack" style="display:none">
          <div class="bj-wrap">
            <div class="banner" id="bjMsg">Place your bet to begin.</div>
            <div class="bj-table">
              <div class="flex" style="justify-content:space-between">
                <div class="kv">Dealer</div>
              </div>

              <div class="hand" style="justify-content:center;align-items:center;margin-top:8px;gap:12px">
                <img id="dealerAvatar" style="width:56px;height:56px;border-radius:12px;border:1px solid rgba(255,255,255,.15);object-fit:cover" />
                <div id="dealerHand" class="hand"></div>
                <span class="badge" id="dealerVal">‚Äî</span>
              </div>

              <div class="flex" style="justify-content:space-between;margin-top:6px">
                <div class="kv">Player: <b id="bjUser">‚Äî</b></div>
                <div class="kv">Balance: <b id="bjBal">$0</b></div>
              </div>

              <div class="hand" style="justify-content:center;align-items:center;margin-top:6px;gap:12px">
                <img id="playerAvatar" style="width:56px;height:56px;border-radius:12px;border:1px solid rgba(255,255,255,.15);object-fit:cover" />
                <div id="playerHand" class="hand"></div>
                <span class="badge" id="playerVal">‚Äî</span>
              </div>

              <div class="controls" style="justify-content:center;margin-top:8px">
                <button id="btnDeal" class="accent">Deal</button>
                <button id="btnHit">Hit</button>
                <button id="btnStand">Stand</button>
                <button id="btnDouble">Double</button>
                <button id="btnNewRound" class="ghost">New Round</button>
              </div>

              <div class="flex" style="justify-content:center;margin-top:10px">
                <div class="rack" id="chipRack" style="gap:14px">
                  <button class="chip chip-blue"   data-bet="10"><span>$10</span></button>
                  <button class="chip chip-green"  data-bet="25"><span>$25</span></button>
                  <button class="chip chip-red"    data-bet="50"><span>$50</span></button>
                  <button class="chip chip-black"  data-bet="100"><span>$100</span></button>
                  <button class="chip chip-purple" data-bet="500"><span>$500</span></button>
                  <button class="chip chip-yellow" data-bet="1000"><span>$1k</span></button>
                  <span class="kv">Bet: <b id="bjBet">$0</b></span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- TicTacToe -->
        <section class="stage-inner" id="tictactoe" style="display:none">
          <div class="flex" style="margin-bottom:8px">
            <div class="badge">Play vs. CPU</div>
            <button id="tttReset" class="ghost">Reset</button>
            <div class="spacer"></div>
            <span class="kv">Wins: <b id="tttWinsLbl">0</b></span>
          </div>
          <div id="tttBoard" style="display:grid;grid-template-columns:repeat(3,120px);gap:12px;justify-content:center;margin:12px auto"></div>
          <div id="tttStatus" class="banner" style="justify-content:center;margin:0 auto;max-width:360px">Make a move.</div>
        </section>

        <!-- Snake -->
        <section class="stage-inner" id="snake" style="display:none">
          <div class="flex" style="margin-bottom:8px">
            <div class="badge">Controls: Arrow Keys</div>
            <div class="spacer"></div>
            <button id="snakeStart" class="accent">Start</button>
            <span class="kv">Score: <b id="snakeScore">0</b></span>
            <span class="kv">Best: <b id="snakeBest">0</b></span>
          </div>
          <canvas id="snakeCanvas" class="game-canvas" width="900" height="540"></canvas>
        </section>

        <!-- Memory -->
        <section class="stage-inner" id="memory" style="display:none">
          <div class="flex" style="margin-bottom:8px">
            <div class="badge">Flip pairs. Fewer moves = better time.</div>
            <div class="spacer"></div>
            <button id="memRestart" class="accent">Restart</button>
            <span class="kv">Moves: <b id="memMoves">0</b></span>
            <span class="kv">Time: <b id="memTime">0.0s</b></span>
          </div>
          <div id="memGrid" style="display:grid;grid-template-columns:repeat(6,100px);gap:12px;justify-content:center;margin:0 auto 12px"></div>
          <div id="memBanner" class="banner" style="justify-content:center;max-width:420px;margin:0 auto">Good luck!</div>
        </section>

      </div>
      <div class="foot muted">¬© <span id="year"></span> Cosmic Games</div>
    </main>
  </div>

  <!-- Help Modal -->
  <div class="modal-back" id="helpBack" style="display:none;position:fixed;inset:0;background:rgba(5,7,20,.6);backdrop-filter:blur(6px);align-items:center;justify-content:center;z-index:10">
    <div class="modal" style="width:min(720px,92vw);background:linear-gradient(180deg,#0b0e2b,#090b1f);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px">
      <div class="flex" style="justify-content:space-between">
        <h2>How to Play</h2>
        <button id="closeHelp" class="ghost">‚úñ</button>
      </div>
      <ul>
        <li><b>Astro Shooter:</b> Use ‚Üê ‚Üí to move the ship and Space to fire. Clear meteors to advance levels.</li>
        <li><b>Blackjack:</b> Click chips to set a bet, then Deal. Hit/Stand/Double.</li>
        <li><b>Snake:</b> Eat glowing orbs, don‚Äôt hit yourself. Faster over time.</li>
        <li><b>Tic‚ÄëTac‚ÄëToe:</b> You‚Äôre ‚ùå, CPU is ‚≠ï.</li>
        <li><b>Memory:</b> Match pairs of meteor/planet tiles.</li>
      </ul>
      <p class="muted">Your username, balance, and highscores are stored in your browser with localStorage.</p>
    </div>
  </div>
</div>

<script>
/* -------------------------
   Persistent profile & bank
--------------------------*/
const store = {
  get k(){ return 'cosmic.games.v1'},
  load(){ try{ return JSON.parse(localStorage.getItem(this.k))||{} }catch{ return {} } },
  save(data){ localStorage.setItem(this.k, JSON.stringify(data)) }
};
const state = Object.assign({
  user:'', bank:1000,
  hi:{ shooter:0, bankroll:1000, snake:0, tttWins:0, memBest:null },
  selectedAvatar: 0, selectedAvatarData: null
}, store.load());

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

const username = $('#username');
const saveUser = $('#saveUser');
const bal = $('#bal');
const bjUser = $('#bjUser');
const bjBal = $('#bjBal');
const hiShooter = $('#hiShooter');
const hiBankroll = $('#hiBankroll');
const hiSnake = $('#hiSnake');
const tttWins = $('#tttWins');
const tttWinsLbl = $('#tttWinsLbl');
const memBest = $('#memBest');

function renderProfile(){
  username.value = state.user || '';
  bal.textContent = `$${state.bank.toLocaleString()}`;
  if(bjUser) bjUser.textContent = state.user || 'Player';
  if(bjBal) bjBal.textContent = `$${state.bank.toLocaleString()}`;
  if(hiShooter) hiShooter.textContent = state.hi.shooter;
  if(hiBankroll) hiBankroll.textContent = `$${(state.hi.bankroll||0).toLocaleString()}`;
  if(hiSnake) hiSnake.textContent = state.hi.snake;
  if(tttWins) tttWins.textContent = state.hi.tttWins;
  if(tttWinsLbl) tttWinsLbl.textContent = state.hi.tttWins;
  if(memBest) memBest.textContent = state.hi.memBest ? state.hi.memBest + 's' : '‚Äî';
}
saveUser.addEventListener('click', ()=>{
  state.user = username.value.trim() || 'Player';
  if(state.bank==null || Number.isNaN(state.bank)) state.bank = 1000;
  state.hi.bankroll = Math.max(state.hi.bankroll||0, state.bank);
  store.save(state); renderProfile();
});
renderProfile();
$('#year').textContent = new Date().getFullYear();

/* -------------------------
   Router (sidebar switching)
--------------------------*/
const gameList = $('#gameList');
const sections = ['landing','customize','shooter','blackjack','tictactoe','snake','memory'].map(id=>$('#'+id));
gameList.addEventListener('click', (e)=>{
  const item = e.target.closest('.game-item'); if(!item) return;
  const game = item.dataset.game;
  $$('.game-item').forEach(n=>n.classList.remove('active'));
  item.classList.add('active');
  sections.forEach(s=>s.style.display = s.id===game?'block':'none');
});

/* -------------------------
   Background: starfield + nebula
--------------------------*/
(function(){
  const neb = document.getElementById('nebula');
  const nctx = neb.getContext('2d');
  const star = document.getElementById('starfield');
  const sctx = star.getContext('2d');
  let W,H; let stars=[], layers=[0.2,0.6,1.2]; // parallax
  function resize(){
    W = star.width = neb.width = window.innerWidth;
    H = star.height = neb.height = window.innerHeight;
    const count = Math.min(700, Math.floor(W*H/2500));
    stars = [...Array(count)].map(()=>({x: Math.random()*W,y: Math.random()*H,z: layers[Math.floor(Math.random()*layers.length)],r: Math.random()*1.6+0.2,tw: Math.random()*Math.PI*2}));
  }
  window.addEventListener('resize', resize); resize();
  let t=0;
  function drawNebula(){
    nctx.clearRect(0,0,W,H);
    const grad = nctx.createRadialGradient(W*0.3 + Math.sin(t*.0002)*120, H*0.25 + Math.cos(t*.00015)*80, 50, W*0.5, H*0.6, Math.max(W,H)*0.9);
    grad.addColorStop(0,'rgba(122,162,255,.25)');
    grad.addColorStop(.3,'rgba(142,245,255,.22)');
    grad.addColorStop(.7,'rgba(80,100,210,.15)');
    grad.addColorStop(1,'rgba(0,0,0,0)');
    nctx.fillStyle = grad; nctx.fillRect(0,0,W,H);
  }
  function drawStars(){
    sctx.clearRect(0,0,W,H);
    for(const st of stars){
      st.x -= st.z * 0.15; if(st.x< -5){ st.x=W+5; st.y=Math.random()*H }
      st.tw += 0.05*st.z;
      const alpha = 0.6 + Math.sin(st.tw)*0.4;
      sctx.fillStyle = `rgba(220,235,255,${alpha})`;
      sctx.beginPath(); sctx.arc(st.x, st.y, st.r*st.z, 0, Math.PI*2); sctx.fill();
    }
  }
  function loop(ms){ t = ms; drawNebula(); drawStars(); requestAnimationFrame(loop); }
  requestAnimationFrame(loop);
})();

/* -------------------------
   Astro Shooter (same as before)
--------------------------*/
(function(){
  const c = document.getElementById('shooterCanvas');
  const ctx = c.getContext('2d');
  const startBtn = document.getElementById('shooterStart');
  const lvlLbl = document.getElementById('lvl');
  const scoreLbl = document.getElementById('score');
  const livesLbl = document.getElementById('lives');
  let running=false, paused=false;
  const W=c.width, H=c.height;
  function pxRect(x,y,w,h,color){ ctx.imageSmoothingEnabled=false; ctx.fillStyle=color; ctx.fillRect(Math.floor(x),Math.floor(y),Math.floor(w),Math.floor(h)); }
  const keys={};
  window.addEventListener('keydown',e=>{ if(sections.find(s=>s.id==='shooter').style.display!=='block') return; keys[e.key]=true; if(e.key==='p'||e.key==='P'){paused=!paused} });
  window.addEventListener('keyup',e=>{keys[e.key]=false});

  let player, bullets, rocks, score, lives, level, planetX, planetY, planetR, planetIn=false;
  function resetGame(){ player={x:W/2-12,y:H-70,w:24,h:24,speed:5,cd:0}; bullets=[]; rocks=[]; score=0; lives=3; level=1; planetIn=false; planetX=W/2; planetY=-120; planetR=50; lvlLbl.textContent=level; scoreLbl.textContent=score; livesLbl.textContent=lives; }
  function spawnWave(){ const count = 6 + level*2; for(let i=0;i<count;i++){ rocks.push({x: Math.random()*W, y: -Math.random()*400-20, r: 10 + Math.random()*16 + level*0.6, vy: 1.2 + level*0.25 + Math.random()*0.6, vx: (Math.random()-.5)*(0.5+level*0.1), hp: 1 + Math.floor(level/2), comet: Math.random()<Math.min(0.05*level, .25)}); } }
  function drawShip(){ const {x,y,w,h}=player; pxRect(x,y,w,h,'#a6b4ff'); pxRect(x+6,y-8,12,8,'#cfe4ff'); pxRect(x+4,y+h,16,6,'#ffdf6e'); pxRect(x+4,y+h+6,16,4,'#ffa44d'); }
  function drawPlanet(){ if(!planetIn) return; const g=ctx.createRadialGradient(planetX,planetY,10,planetX,planetY,planetR*1.6); g.addColorStop(0,'#8ef5ff'); g.addColorStop(1,'rgba(142,245,255,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(planetX,planetY,planetR*1.6,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#7aa2ff'; ctx.beginPath(); ctx.arc(planetX,planetY,planetR,0,Math.PI*2); ctx.fill(); }
  function step(){ if(!running){return} if(paused){ requestAnimationFrame(step); return; } ctx.clearRect(0,0,W,H);
    if(rocks.length===0 && !planetIn){ planetIn=true; } if(planetIn){ planetY += 0.6; if(planetY>H-200){ level++; lvlLbl.textContent=level; planetIn=false; planetY=-120; spawnWave(); } } drawPlanet();
    if(keys['ArrowLeft']) player.x -= player.speed; if(keys['ArrowRight']) player.x += player.speed; player.x = Math.max(6, Math.min(W-30, player.x)); drawShip();
    player.cd = Math.max(0, player.cd-1); if(keys[' '] && player.cd===0){ bullets.push({x:player.x+11,y:player.y-6,v: -8}); player.cd=8; }
    ctx.fillStyle='#8ef5ff'; bullets.forEach(b=>{ b.y += b.v; ctx.fillRect(b.x,b.y,4,8) }); bullets = bullets.filter(b=>b.y>-20);
    for(const r of rocks){ r.x += r.vx; r.y += r.vy*(r.comet?1.6:1); if(r.x<-30) r.x=W+30; if(r.x>W+30) r.x=-30; pxRect(r.x-r.r, r.y-r.r, r.r*2, r.r*2, r.comet?'#ffe08a':'#c5ccff'); pxRect(r.x-r.r*0.5, r.y-r.r*0.5, r.r, r.r, r.comet?'#ffc166':'#e8ecff'); }
    for(const b of bullets){ for(const r of rocks){ const dx=b.x-(r.x), dy=b.y-(r.y), d=dx*dx+dy*dy; if(d<(r.r*r.r)){ r.hp--; b.y=-9999; score+=10; scoreLbl.textContent=score; } } }
    rocks = rocks.filter(r=>{ if(r.hp<=0){ score+=15; scoreLbl.textContent=score; return false } return r.y<H+40; });
    for(const r of rocks){ const inX = player.x < r.x+r.r && player.x+player.w > r.x-r.r; const inY = player.y < r.y+r.r && player.y+player.h > r.y-r.r; if(inX && inY){ lives--; livesLbl.textContent=lives; r.y = H+100; if(lives<=0){ running=false; state.hi.shooter = Math.max(state.hi.shooter, score); store.save(state); renderProfile(); ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(0,0,W,H); ctx.fillStyle='#fff'; ctx.font='28px monospace'; ctx.textAlign='center'; ctx.fillText('Game Over', W/2, H/2-10); ctx.fillText(`Score: ${score}`, W/2, H/2+24); return; } } }
    requestAnimationFrame(step);
  }
  startBtn.addEventListener('click', ()=>{ resetGame(); spawnWave(); running=true; paused=false; requestAnimationFrame(step); });
})();

/* -------------------------
   Blackjack (avatars + delays + counts + sounds)
--------------------------*/
(function(){
  const suits = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
  const colors = { '‚ô†':'black','‚ô£':'black','‚ô•':'red','‚ô¶':'red' };
  const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  let deck = [];
  let dealer=[], player=[], hidden=true;
  let bet=0, dealing=false;

  const msg = $('#bjMsg');
  const dealerHand = $('#dealerHand');
  const playerHand = $('#playerHand');
  const betLbl = $('#bjBet');
  const balLbl = $('#bjBal');
  const btnDeal = $('#btnDeal'), btnHit = $('#btnHit'), btnStand = $('#btnStand'), btnDouble = $('#btnDouble'), btnNew = $('#btnNewRound');
  const dealerVal = $('#dealerVal'), playerVal = $('#playerVal');
  const dealerAvatar = $('#dealerAvatar'), playerAvatar = $('#playerAvatar');

  // sounds via WebAudio
  const AC = new (window.AudioContext||window.webkitAudioContext)();
  function beep(seq){
    let t = AC.currentTime;
    seq.forEach(s=>{
      const o = AC.createOscillator(), g=AC.createGain();
      o.type = s.type||'sine'; o.frequency.value=s.f;
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.2,t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t + s.d/1000);
      o.connect(g).connect(AC.destination);
      o.start(t); o.stop(t + s.d/1000);
      t += s.d/1000 + 0.02;
    });
  }
  const sfx = {
    blackjack: ()=>beep([{f:880,d:120},{f:1320,d:140},{f:1760,d:160,type:'triangle'}]),
    lose: ()=>beep([{f:330,d:180},{f:246,d:220,type:'sawtooth'}]),
    win: ()=>beep([{f:392,d:90},{f:523,d:90},{f:659,d:140,type:'square'}]),
    deal: ()=>beep([{f:320,d:25,type:'square'}])
  };

  function buildDeck(){ deck = []; for(const s of suits){ for(const r of ranks){ deck.push({s,r}); } } for(let i=deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; } }
  function cardValue(c){ if(c.r==='A') return 11; if(['K','Q','J'].includes(c.r)) return 10; return parseInt(c.r,10); }
  function handValue(arr){ let total = arr.reduce((s,c)=>s+cardValue(c),0); let aces = arr.filter(c=>c.r==='A').length; while(total>21 && aces>0){ total-=10; aces--; } return total; }
  function renderHand(el, arr, hideFirst=false){
    el.innerHTML='';
    arr.forEach((c,i)=>{
      const cardEl = document.createElement('div');
      cardEl.className = 'card ' + (colors[c.s]==='red'?'red':'black');
      if(hideFirst && i===0){ cardEl.className+=' back'; el.appendChild(cardEl); return; }
      const top = document.createElement('div'); top.className='rank'; top.textContent=c.r;
      const suit = document.createElement('div'); suit.className='suit'; suit.textContent=c.s;
      const pips = document.createElement('div'); pips.className='pips'; pips.textContent=c.s;
      cardEl.appendChild(top); cardEl.appendChild(suit); cardEl.appendChild(pips);
      el.appendChild(cardEl);
    });
  }
  function setMsg(text, type=''){ msg.className='banner'+(type?(' '+type):''); msg.textContent=text; }
  function resetRound(){
    dealer=[]; player=[]; hidden=true; dealing=false;
    renderHand(dealerHand, dealer, false); renderHand(playerHand, player, false);
    dealerVal.textContent='‚Äî'; playerVal.textContent='‚Äî';
    btnHit.disabled=btnStand.disabled=btnDouble.disabled=true; btnDeal.disabled=false; btnNew.disabled=true;
    setMsg('Place your bet to begin.'); bet=0; betLbl.textContent='$0';
    // avatars
    dealerAvatar.src = makeAvatar(Math.floor(Math.random()*999)+100,128);
    playerAvatar.src = state.selectedAvatarData || makeAvatar(1,128);
  }
  function ensureDeck(){ if(deck.length<15) buildDeck(); }
  function updateVals(){ const pv = handValue(player); playerVal.textContent = pv; dealerVal.textContent = hidden ? '??' : handValue(dealer); }
  function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }

  async function dealSequence(){
    dealing=true;
    player.push(deck.pop()); sfx.deal(); renderHand(playerHand, player, false); updateVals(); await wait(250);
    dealer.push(deck.pop()); sfx.deal(); renderHand(dealerHand, dealer, true);  updateVals(); await wait(250);
    player.push(deck.pop()); sfx.deal(); renderHand(playerHand, player, false); updateVals(); await wait(250);
    dealer.push(deck.pop()); sfx.deal(); renderHand(dealerHand, dealer, true);  updateVals(); dealing=false;
  }

  async function deal(){
    if(bet<=0){ setMsg('Select a bet first.',''); return; }
    if(state.bank<bet){ setMsg('Insufficient balance.','lose'); return; }
    ensureDeck(); dealer=[]; player=[]; hidden=true;
    state.bank -= bet; store.save(state); renderProfile(); balLbl.textContent = `$${state.bank.toLocaleString()}`;
    renderHand(dealerHand, dealer, true); renderHand(playerHand, player, false);
    btnHit.disabled=btnStand.disabled=btnDouble.disabled=true; btnDeal.disabled=true; btnNew.disabled=true;
    setMsg('Dealing...'); await dealSequence();
    const pVal = handValue(player); updateVals();
    if(pVal===21){ hidden=false; renderHand(dealerHand, dealer, false); updateVals();
      const dVal = handValue(dealer);
      if(dVal===21){ setMsg('Push. Blackjack vs Blackjack.',''); state.bank += bet; }
      else { const win = Math.floor(bet*1.5)+bet; state.bank+=win; setMsg('Blackjack! Paid 3:2','win'); sfx.blackjack(); }
      state.hi.bankroll = Math.max(state.hi.bankroll||0, state.bank);
      store.save(state); renderProfile(); btnNew.disabled=false; btnHit.disabled=btnStand.disabled=btnDouble.disabled=true; return; }
    setMsg('Your move.'); btnHit.disabled=btnStand.disabled=btnDouble.disabled=false;
  }

  async function hit(){
    if(dealing) return; ensureDeck(); dealing=true;
    player.push(deck.pop()); sfx.deal(); renderHand(playerHand, player, false); updateVals(); await wait(220);
    dealing=false;
    const v=handValue(player);
    if(v>21){ hidden=false; renderHand(dealerHand, dealer, false); updateVals(); setMsg('Busted. Dealer wins.','lose'); sfx.lose();
      btnHit.disabled=btnStand.disabled=btnDouble.disabled=true; btnNew.disabled=false; }
  }

  async function stand(){
    btnHit.disabled=btnStand.disabled=btnDouble.disabled=true;
    hidden=false; renderHand(dealerHand, dealer, false); updateVals();
    while(handValue(dealer)<17){ ensureDeck(); dealing=true;
      dealer.push(deck.pop()); sfx.deal(); renderHand(dealerHand, dealer, false); updateVals(); await wait(280); }
    const p=handValue(player), d=handValue(dealer);
    if(d>21 || p>d){ state.bank+=bet*2; setMsg('You win!','win'); sfx.win(); }
    else if(p===d){ state.bank+=bet; setMsg('Push.',''); }
    else { setMsg('Dealer wins.','lose'); sfx.lose(); }
    state.hi.bankroll = Math.max(state.hi.bankroll||0, state.bank);
    store.save(state); renderProfile(); btnNew.disabled=false;
  }

  function dbl(){ if(state.bank<bet){ setMsg('Not enough balance to double.','lose'); return; }
    state.bank -= bet; bet*=2; betLbl.textContent = `$${bet}`; store.save(state); renderProfile();
    hit().then(()=>{ if(handValue(player)<=21) stand(); });
  }

  $('#chipRack').addEventListener('click', (e)=>{ const v = e.target.closest('.chip')?.getAttribute('data-bet'); if(!v) return; bet = parseInt(v,10); betLbl.textContent = `$${bet.toLocaleString()}`; setMsg('Ready. Press Deal.'); });
  btnDeal.addEventListener('click', ()=>deal());
  btnHit.addEventListener('click', ()=>hit());
  btnStand.addEventListener('click', ()=>stand());
  btnDouble.addEventListener('click', ()=>dbl());
  btnNew.addEventListener('click', resetRound);

  buildDeck(); resetRound();
})();

/* -------------------------
   TicTacToe (vs CPU)
--------------------------*/
(function(){
  const boardEl = $('#tttBoard');
  const status = $('#tttStatus');
  let board, turn, over;
  function draw(){ boardEl.innerHTML=''; board.forEach((v,i)=>{ const btn=document.createElement('button'); btn.style.width='120px'; btn.style.height='120px'; btn.style.fontSize='34px'; btn.style.borderRadius='12px'; btn.style.border='1px solid rgba(255,255,255,.1)'; btn.style.background='#0b0e2b'; btn.textContent=v||''; btn.addEventListener('click', ()=>move(i)); boardEl.appendChild(btn); }); }
  function reset(){ board=Array(9).fill(''); turn='X'; over=false; status.textContent='Make a move.'; draw(); }
  function win(b,p){ const lines=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]; return lines.some(l=>l.every(i=>b[i]===p)); }
  function ai(){ const me='O', you='X'; let i = bestMove(me) ?? bestMove(you) ?? [4,0,2,6,8].find(i=>!board[i]); if(i==null){ const empties=board.map((v,idx)=>v?null:idx).filter(v=>v!=null); i=empties[Math.floor(Math.random()*empties.length)] } board[i]=me; turn='X'; draw(); if(win(board,me)){ status.textContent='CPU wins.'; over=true } else if(board.every(Boolean)){ status.textContent='Draw.'; over=true } }
  function bestMove(p){ const lines=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]; for(const [a,b,c] of lines){ const cells=[board[a],board[b],board[c]]; if(cells.filter(v=>v===p).length===2 && cells.includes('')) return [a,b,c][cells.indexOf('')]; } return null; }
  function move(i){ if(over || board[i]) return; board[i]='X'; turn='O'; draw(); if(win(board,'X')){ status.textContent='You win!'; over=true; state.hi.tttWins=(state.hi.tttWins||0)+1; store.save(state); renderProfile(); return } if(board.every(Boolean)){ status.textContent='Draw.'; over=true; return} setTimeout(ai, 260); }
  $('#tttReset').addEventListener('click', reset); reset();
})();

/* -------------------------
   Snake
--------------------------*/
(function(){
  const c = document.getElementById('snakeCanvas');
  const ctx = c.getContext('2d');
  const startBtn = $('#snakeStart');
  const scoreLbl = $('#snakeScore');
  const bestLbl = $('#snakeBest');
  let grid=30, vx=1, vy=0, snake, food, score, loop, speed;
  function rndCell(){ return Math.floor(Math.random()*(c.width/grid)) }
  function reset(){ snake=[{x:5,y:9},{x:4,y:9},{x:3,y:9}]; vx=1; vy=0; score=0; speed=120; food={x:rndCell(), y:rndCell()}; scoreLbl.textContent=score; bestLbl.textContent=state.hi.snake||0; clearInterval(loop); loop=setInterval(step, speed); }
  window.addEventListener('keydown', e=>{ if(e.key==='ArrowLeft' && vx!==1){vx=-1;vy=0} else if(e.key==='ArrowRight' && vx!==-1){vx=1;vy=0} else if(e.key==='ArrowUp' && vy!==1){vx=0;vy=-1} else if(e.key==='ArrowDown' && vy!==-1){vx=0;vy=1} });
  function step(){ const head = {x:snake[0].x+vx, y:snake[0].y+vy}; if(head.x<0) head.x = c.width/grid-1; if(head.y<0) head.y = c.height/grid-1; head.x%=c.width/grid; head.y%=c.height/grid; if(snake.some(s=>s.x===head.x && s.y===head.y)){ gameOver(); return; } snake.unshift(head);
    if(head.x===food.x && head.y===food.y){ score++; scoreLbl.textContent=score; state.hi.snake = Math.max(state.hi.snake||0, score); store.save(state); renderProfile(); food={x:rndCell(), y:rndCell()}; clearInterval(loop); speed=Math.max(60, 120 - score*3); loop=setInterval(step, speed); state.bank += 1; store.save(state); renderProfile(); } else snake.pop();
    ctx.clearRect(0,0,c.width,c.height); ctx.fillStyle='#0a0d22'; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='#8ef5ff'; ctx.fillRect(food.x*grid, food.y*grid, grid-2, grid-2); ctx.fillStyle='#7aa2ff'; snake.forEach((s,i)=>ctx.fillRect(s.x*grid, s.y*grid, grid-2, grid-2)); }
  function gameOver(){ clearInterval(loop); ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='#fff'; ctx.font='28px Inter, system-ui'; ctx.textAlign='center'; ctx.fillText('Game Over', c.width/2, c.height/2-10); ctx.fillText(`Score: ${score}`, c.width/2, c.height/2+24); }
  startBtn.addEventListener('click', reset);
})();

/* -------------------------
   Memory (Meteor Match)
--------------------------*/
(function(){
  const icons = ['‚òÑÔ∏è','ü™ê','üåë','‚≠ê','üåü','üåå','üöÄ','üõ∞Ô∏è','üå†','üõ∏','üßë‚ÄçüöÄ','üî≠'];
  let deck=[], first=null, second=null, moves=0, startTime=0, timer=null, done=0;
  const grid = $('#memGrid'), movesLbl = $('#memMoves'), timeLbl = $('#memTime'), banner=$('#memBanner');
  function setup(){ const chosen = icons.slice(0,12); deck = [...chosen, ...chosen].sort(()=>Math.random()-0.5).map((v,i)=>({id:i, v, open:false, matched:false}));
    grid.innerHTML=''; moves=0; timeLbl.textContent='0.0s'; done=0; first=second=null; movesLbl.textContent=0; startTime = performance.now(); clearInterval(timer);
    timer=setInterval(()=>{ timeLbl.textContent = ((performance.now()-startTime)/1000).toFixed(1)+'s' }, 100);
    for(const card of deck){ const btn=document.createElement('button'); btn.style.width='100px'; btn.style.height='120px'; btn.style.fontSize='32px'; btn.style.borderRadius='12px'; btn.style.border='1px solid rgba(255,255,255,.1)'; btn.style.background='#0b0e2b'; btn.textContent='‚ùî'; btn.dataset.id=card.id; btn.addEventListener('click', ()=>flip(card, btn)); grid.appendChild(btn); }
    banner.textContent='Good luck!'; }
  function flip(card, btn){ if(card.open || card.matched) return; card.open=true; btn.textContent=card.v; if(!first){ first={card,btn}; return; }
    if(!second){ second={card,btn}; moves++; movesLbl.textContent=moves; if(first.card.v===second.card.v){ first.card.matched=second.card.matched=true; done+=2; first=null; second=null; if(done===deck.length){ clearInterval(timer); const secs = parseFloat(timeLbl.textContent); banner.textContent='All matched! üéâ'; if(!state.hi.memBest || secs<state.hi.memBest){ state.hi.memBest=secs.toFixed(1); store.save(state); renderProfile(); } state.bank+=25; store.save(state); renderProfile(); } } else { setTimeout(()=>{ first.card.open=false; second.card.open=false; first.btn.textContent='‚ùî'; second.btn.textContent='‚ùî'; first=null; second=null; }, 600); } } }
  $('#memRestart').addEventListener('click', setup); setup();
})();

/* -------------------------
   Help modal + sound toggle
--------------------------*/
(function(){
  const back = $('#helpBack');
  $('#openHelp').addEventListener('click', ()=> back.style.display='flex');
  $('#closeHelp').addEventListener('click', ()=> back.style.display='none');
  const btnSound = $('#btnSound'); let on=true; btnSound.addEventListener('click', ()=>{ on=!on; btnSound.textContent = on?'üîä Sound On':'üîá Sound Off' });
})();

/* -------------------------
   Avatars (procedural generator)
--------------------------*/
const AVATAR_SEEDS = Array.from({length:24},(_,i)=>i+1);
function makeAvatar(seed, size=256){
  const c=document.createElement('canvas'); c.width=c.height=size; const ctx=c.getContext('2d');
  const rnd = (n)=>Math.abs(Math.sin(seed*9973+n*37));
  ctx.fillStyle = `hsl(${Math.floor(rnd(1)*360)}, 60%, 18%)`; ctx.fillRect(0,0,size,size);
  const g=16, cell=size/g;
  function dot(x,y,h,s,l){ ctx.fillStyle=`hsl(${h},${s}%,${l}%)`; ctx.fillRect(x*cell,y*cell,cell,cell); }
  const skinL = 55 + Math.floor(rnd(2)*20);
  const hairH = Math.floor(rnd(3)*360);
  for(let y=4;y<12;y++){ for(let x=4;x<12;x++){ if((x-8)**2+(y-8)**2<=16) dot(x,y,30,35,skinL); } }
  dot(6,8,220,20,90); dot(9,8,220,20,90); dot(6,8,220,80,15); dot(9,8,220,80,15);
  dot(7,10,0,0,10); dot(8,10,0,0,10);
  for(let x=4;x<12;x++){ if(rnd(x)>0.25) dot(x,4,hairH,65,25); }
  for(let x=5;x<11;x++){ if(rnd(x+1)>0.35) dot(x,5,hairH,65,25); }
  return c.toDataURL('image/png');
}

// Customize page setup
(function setupCustomize(){
  const grid = document.getElementById('avatarGrid');
  if(!grid) return;
  const preview = document.getElementById('avatarPreview');
  const saveBtn = document.getElementById('saveAvatar');
  const AVS = AVATAR_SEEDS.map(s=>makeAvatar(s,256));
  grid.innerHTML='';
  AVS.forEach((src,i)=>{
    const d=document.createElement('div'); d.className='avatar-tile'; d.dataset.i=i;
    const img=new Image(); img.src=src; d.appendChild(img);
    d.onclick=()=>{ [...grid.children].forEach(n=>n.classList.remove('active')); d.classList.add('active'); preview.src=src; preview.dataset.i=i };
    grid.appendChild(d);
  });
  const saved = state.selectedAvatar ?? 0;
  preview.src = AVS[saved]; preview.dataset.i=saved;
  grid.children[saved]?.classList.add('active');
  saveBtn.onclick=()=>{
    state.selectedAvatar = parseInt(preview.dataset.i||'0',10);
    state.selectedAvatarData = preview.src;
    store.save(state);
    // show in logo
    const logo = document.querySelector('.logo'); if(logo){ logo.style.background='transparent'; logo.textContent=''; const img = new Image(); img.alt='avatar'; img.style.width='28px'; img.style.height='28px'; img.style.borderRadius='6px'; img.src = state.selectedAvatarData; logo.appendChild(img); }
    alert('Saved!');
  };
})();

// Show avatar in top-left logo if exists
(function(){
  const logo = document.querySelector('.logo');
  if(logo && state.selectedAvatarData){
    logo.style.background='transparent'; logo.textContent='';
    const img = new Image(); img.alt='avatar'; img.style.width='28px'; img.style.height='28px'; img.style.borderRadius='6px'; img.src = state.selectedAvatarData; logo.appendChild(img);
  }
})();
</script>
</body>
</html>
