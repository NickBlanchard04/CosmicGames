<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cosmic Games</title>
<link rel="icon" href="favicon.ico">
<style>
:root{
  --bg:#0b0f2a;--panel:#0f1635;--panel2:#10183c;--ink:#e9f0ff;--muted:#9cb3ff;
  --accent:#6ea7ff;--accent2:#5a89ff;--good:#3bd37f;--warn:#f4c430;--bad:#ff6b6b;
  --chip-g:#2fc36c;--chip-b:#3e78ff;--chip-r:#ff5252;--chip-k:#666;--chip-p:#7b61ff;--chip-y:#ffbf36;
  --rail:#213245;--felt1:#0d3a38;--felt2:#082725;--spaceGlow:#7aa2ff55;
  --ring:#204;--planet:#1a244a;--planet2:#193a4a;
  font-synthesis-weight:none;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(80vw 80vh at 110vw 90vh,#1d2a56 0,#0d1330 55%,#070a1c 75%,#030517 100%);color:var(--ink);font:16px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
/* starfield + solar system */
.bg{
  position:fixed;inset:0;overflow:hidden;pointer-events:none;z-index:-1;
}
.stars, .planets{position:absolute;inset:0}
.stars::before, .stars::after{
  content:"";position:absolute;inset:-20%;background:
  radial-gradient(2px 2px at 10% 20%,#fff8 40%,#0000 42%),
  radial-gradient(1.5px 1.5px at 40% 60%,#fff6 40%,#0000 42%),
  radial-gradient(1.2px 1.2px at 70% 40%,#fff7 40%,#0000 42%),
  radial-gradient(1.4px 1.4px at 85% 80%,#fff8 40%,#0000 42%),
  radial-gradient(1.1px 1.1px at 25% 85%,#fff6 40%,#0000 42%);
  animation: drift 120s linear infinite;
}
.stars::after{animation-duration:180s;opacity:.7}
@keyframes drift{to{transform:translateX(-20%)}}
.planet{position:absolute;--s:140px;width:var(--s);height:var(--s);border-radius:50%;
  background:radial-gradient(circle at 30% 30%,#fff6 0 15%,#0000 16%),
             radial-gradient(circle at 65% 50%,#fff3 0 12%,#0000 13%),
             radial-gradient(circle at 50% 50%,#3c5ca8 0,#21325c 60%,#0d183a 100%);
  box-shadow:0 0 0 6px #0b1240 inset,0 0 40px 5px #6ea7ff22;
  top:75%;left:85%;filter:saturate(1.15);
  animation: planetSlide 120s linear infinite;
}
.planet.small{--s:80px;top:20%;left:60%;filter:hue-rotate(40deg) saturate(1.25)}
.planet.ring::after{
  content:"";position:absolute;inset:-14px;transform:skewY(-12deg) rotate(-12deg);
  border:6px solid #7090ff55;border-left-color:#0000;border-right-color:#0000;border-radius:50%;
  filter:blur(.5px) drop-shadow(0 0 8px #88aaff55);
}
@keyframes planetSlide{to{transform:translateX(-120vw)}}

/* layout */
.wrap{max-width:1100px;margin:40px auto;padding:0 20px}
.row{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-bottom:14px}
.input{display:flex;align-items:center;background:var(--panel2);border:1px solid #1d2655;border-radius:12px;padding:8px 12px;gap:8px}
.input input{all:unset;width:240px;color:var(--ink)}
.btn{all:unset;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;border-radius:12px;padding:10px 14px;background:#1a2455;border:1px solid #24307a;color:#e9f1ff;transition:.15s}
.btn:hover{filter:brightness(1.1)}
.btn.ghost{background:#0e153d;border-color:#1a2258;color:#b8c6ff}
.badge{background:#0b1340;border:1px solid #1a2466;border-radius:999px;padding:6px 12px}
.h1{font-size:28px;font-weight:800;margin:10px 0 18px}
.card{background:var(--panel);border:1px solid #1b2355;border-radius:16px;padding:18px}
.hidden{display:none !important}
.kv{color:#c6d3ff}
a.like{color:var(--muted);text-decoration:none}

/* landing list vertical */
.list{display:grid;gap:12px}
.tile{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px;border-radius:12px;background:#0e153f;border:1px solid #1a2355}
.tile .left{display:flex;gap:10px;align-items:center}
.badge.game{background:#0b1340;border-color:#1d2972}

/* tabs/pages */
section{margin-top:14px}
#blackjack .table,#pool .table{background:radial-gradient(100% 100% at 50% 50%,#10203a 0,#0b1432 55%,#08102a 100%);border:1px solid #16225a;border-radius:18px}
.flex{display:flex}
.center{justify-content:center;align-items:center}

/* Blackjack */
.bj-wrap{display:grid;gap:12px}
.bj-table{position:relative;border-radius:16px;border:1px solid #23315f;background:radial-gradient(980px 540px at 60% 120%,rgba(30,62,125,.12),transparent 60%),radial-gradient(980px 580px at 80% -60%,rgba(42,85,180,.10),transparent 60%),radial-gradient(1280px 720px at -80% 40%,rgba(12,24,72,.12),rgba(8,12,28,.0));padding:18px;min-height:520px}
.rules{font-size:.875rem;color:#cfe0ff}
.banner{display:flex;align-items:center;justify-content:center;gap:.6rem;padding:.6rem .8rem;border-radius:999px;background:#0e153f;border:1px solid #1d2a78;box-shadow:0 0 12px #2035a455 inset}
.banner .win{color:var(--good)} .banner .loss{color:#ff9aa9}
.hand{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.card{width:76px;height:106px;border-radius:12px;background:#fff;border:1px solid #ccd5ff;box-shadow:0 6px 18px rgba(0,0,0,.25);display:grid;grid-template-rows:auto 1fr auto;place-items:center;padding:6px}
.card .s{font-weight:700;font-size:18px}
.card.red{color:#d22} .card.black{color:#111}
.card.back{background:repeating-linear-gradient(45deg,#365,#102255 8px,#0b1a44 8px 16px),radial-gradient(600px 600px at 10% 10%,rgba(255,255,255,.08),transparent 60%)}
.badge.kv{background:#0d1545;color:#b9caff;padding:.36rem .6rem;border-radius:8px}
.controls{display:flex;gap:12px;justify-content:center;margin-top:10px}
.chip-wrap{display:grid;justify-items:center;gap:8px}
.chip-emoji{width:56px;height:56px;display:grid;place-items:center;border-radius:12px;border:1px solid #1d2970;background:#121a3b;color:#fff;font-size:22px;line-height:1;user-select:none;transform:translateZ(0);transition:transform .12s ease, outline .12s}
.chip-emoji:active{transform:scale(.93)}
.chip-label{font-size:12px;font-weight:800;color:#fff;margin-top:4px;text-align:center}

/* Pool */
.p-head{display:flex;gap:12px;align-items:center}
#pOuter{background:radial-gradient(100% 100% at 50% 100%,#0b1338 0,#070f2b 60%,#060b22 100%);border:1px solid #1a2458;border-radius:18px}
#pFrame{padding:10px;border-radius:14px;background:#0a102c;border:1px solid #1b245e}
#pCanvas{display:block;width:100%;max-width:100%;height:520px;border-radius:10px}
.power{height:10px;border-radius:8px;background:#0d133e;border:1px solid #1d2a6b;box-shadow:0 0 0 3px #0a0f32 inset}
#powerFill{height:100%;width:0;border-radius:8px;background:linear-gradient(90deg,#2a8cff,#7aa8ff)}
.turn{margin-left:auto;background:#0c133e;border:1px solid #1b2b6e;padding:.35rem .7rem;border-radius:999px}
.rails{display:flex;gap:18px;flex-wrap:wrap;margin-top:8px}
.rails .title{margin-right:6px;color:#c6d8ff}
.balldot{display:inline-block;width:16px;height:16px;border-radius:50%;box-shadow:0 0 0 1px #0005 inset,0 0 8px #fff1}
.help{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#0008;z-index:60}
.help .box{width:min(720px,92vw);background:#0e153f;border:1px solid #1c2a74;border-radius:16px;padding:18px 20px;box-shadow:0 18px 60px #0009;position:relative}
.help .close{position:absolute;top:8px;right:8px;cursor:pointer;border-radius:8px;padding:6px 8px;background:#1a2455;border:1px solid #26337f}

/* fullscreen toggles */
.fsExit.hidden,.fsEnter.hidden{display:none}

.small{font-size:.9rem;color:#b8c6ff}
.hr{height:1px;background:#1d275a;margin:10px 0;border-radius:1px}
.mute{margin-left:6px}
</style>
</head>
<body>

<div class="bg">
  <div class="stars"></div>
  <div class="planets">
    <div class="planet ring"></div>
    <div class="planet small"></div>
  </div>
</div>

<div class="wrap">
  <!-- top bar -->
  <div class="row">
    <div class="input" style="margin-right:auto">
      <span>👤</span><input id="name" placeholder="Enter username">
      <button class="btn" id="saveName">Save</button>
    </div>
    <button class="btn" id="btnCustom">Customization</button>
    <div class="badge">💰 Balance: <b id="bank">$1,000</b></div>
    <button class="btn ghost mute" id="btnMute">🔊</button>
  </div>

  <!-- Landing -->
  <section id="landing">
    <div class="card">
      <div class="h1">Welcome to <span style="color:#9fc0ff;font-weight:900">Cosmic Games</span> ✨</div>
      <div class="small">Pick a game below. Your name, avatar, calling card, and balance save locally.</div>
      <div class="hr"></div>
      <div class="list">
        <div class="tile">
          <div class="left"><span class="badge game">Blackjack</span> <span>Space table with sounds, instant win on 21, crisp fullscreen.</span></div>
          <button class="btn" onclick="show('blackjack')">Play</button>
        </div>
        <div class="tile">
          <div class="left"><span class="badge game">8-Ball Pool</span> <span>Solids/Stripes vs AI. Pull-back power, rail tracker, help bubble.</span></div>
          <button class="btn" onclick="show('pool')">Play</button>
        </div>
        <div class="tile"><div class="left"><span class="badge game">CHESS IN PROGRESS</span> <span>Stay tuned…</span></div><button class="btn ghost" disabled>Coming soon</button></div>
        <div class="tile"><div class="left"><span class="badge game">SECRET GAME</span> <span>Top secret project.</span></div><button class="btn ghost" disabled>Locked</button></div>
        <div class="tile"><div class="left"><span class="badge game">SECRET GAME</span> <span>Top secret project.</span></div><button class="btn ghost" disabled>Locked</button></div>
      </div>
    </div>
  </section>

  <!-- Customization -->
  <section id="customize" class="hidden">
    <div class="card">
      <div class="h1">Customization</div>
      <div class="small">Choose your avatar and calling card.</div>
      <div class="hr"></div>
      <div style="display:flex;gap:18px;align-items:center;flex-wrap:wrap">
        <div>
          <div class="small">Your avatar</div>
          <img id="avatarPreview" alt="avatar" style="width:96px;height:96px;border-radius:14px;border:1px solid #2a338c;background:#081033;object-fit:cover" />
        </div>
        <button class="btn" id="saveAvatar">Save Selection</button>
      </div>
      <div class="hr"></div>
      <div class="small" style="margin-bottom:8px">Choose an avatar:</div>
      <div id="avatarGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(92px,1fr));gap:12px"></div>
      <div class="hr"></div>
      <div class="small">Calling card</div>
      <input id="cardText" class="input" style="width:280px" placeholder="e.g., THE GOAT">
      <input id="cardColor" class="input" style="width:140px" type="color" value="#7aa2ff">
      <div style="margin-top:12px">
        <button class="btn" onclick="show('landing')">Back</button>
      </div>
    </div>
  </section>

  <!-- Blackjack -->
  <section id="blackjack" class="hidden">
    <div class="card bj-wrap">
      <div class="p-head" style="gap:10px">
        <div class="banner" id="bjMsg">Select a bet first.</div>
        <div class="turn" id="bjNote">Instant win at <b>21</b> • Dealer stands on <b>17</b></div>
        <button class="btn ghost" id="bjFsIn">⤢ Fullscreen</button>
        <button class="btn ghost fsExit hidden" id="bjFsOut">⤡ Exit</button>
        <button class="btn" style="margin-left:auto" onclick="show('landing')">Back</button>
      </div>

      <div class="table bj-table">
        <div class="flex" style="justify-content:space-between">
          <div class="badge kv">Dealer</div>
          <div class="badge kv">Balance: <b id="bjBal">$0</b></div>
        </div>

        <div class="hand" style="justify-content:center;margin-top:10px">
          <img alt="dealer avatar" src="data:image/svg+xml;utf8,<?xml version='1.0'?>\
<svg xmlns='http://www.w3.org/2000/svg' width='56' height='56'><rect width='100%' height='100%' rx='12' ry='12' fill='%2323185c'/>\
<text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-size='26'>%F0%9F%98%88</text></svg>" style="width:56px;height:56px;border-radius:12px;border:1px solid #2a338c;background:#0e0a33;display:block" />
          <div class="badge ghost" id="dealerVal">—</div>
        </div>
        <div id="dealerHand" class="hand"></div>

        <div class="flex" style="justify-content:space-between;margin-top:6px">
          <div class="badge kv">Player: <b id="bjUser">—</b></div>
          <div class="badge ghost" id="playerVal">—</div>
        </div>

        <div class="hand" style="justify-content:center;margin-top:8px">
          <div id="playerAvatar" style="width:56px;height:56px;border-radius:12px;border:1px solid #2a338c;background:#081033"></div>
          <div id="chipTray" class="hand" style="min-height:52px;margin:0 10px;border:1px dashed #31408d;border-radius:12px;padding:6px 12px"></div>
        </div>

        <div class="controls">
          <button id="btnDeal" class="btn">Deal</button>
          <button id="btnHit" class="btn">Hit</button>
          <button id="btnStand" class="btn">Stand</button>
          <button id="btnDouble" class="btn">Double</button>
          <button id="btnNewRound" class="btn">New Round</button>
        </div>

        <div class="flex center" style="gap:18px;margin-top:6px;flex-wrap:wrap">
          <!-- Chips -->
          <div class="chip-wrap">
            <button class="chip-emoji" data-chip="10" style="outline:3px solid var(--chip-g)">🟢</button><div class="chip-label">$10</div>
          </div>
          <div class="chip-wrap">
            <button class="chip-emoji" data-chip="25" style="outline:3px solid var(--chip-b)">🔵</button><div class="chip-label">$25</div>
          </div>
          <div class="chip-wrap">
            <button class="chip-emoji" data-chip="50" style="outline:3px solid var(--chip-r)">🔴</button><div class="chip-label">$50</div>
          </div>
          <div class="chip-wrap">
            <button class="chip-emoji" data-chip="100" style="outline:3px solid var(--chip-k)">⚫</button><div class="chip-label">$100</div>
          </div>
          <div class="chip-wrap">
            <button class="chip-emoji" data-chip="500" style="outline:3px solid var(--chip-p)">🟣</button><div class="chip-label">$500</div>
          </div>
          <div class="chip-wrap">
            <button class="chip-emoji" data-chip="1000" style="outline:3px solid var(--chip-y)">🟡</button><div class="chip-label">$1000</div>
          </div>
        </div>

        <div class="controls">
          <button id="btnUndo" class="btn ghost">Undo</button>
          <button id="btnClear" class="btn ghost">Clear bet</button>
        </div>
      </div>
    </div>
  </section>

  <!-- 8-Ball Pool -->
  <section id="pool" class="hidden">
    <div class="card">
      <div class="p-head">
        <button class="btn ghost" id="pFull">⤢ Fullscreen</button>
        <button class="btn ghost fsExit hidden" id="pExit">⤡ Exit</button>
        <button class="btn" id="pRestart">Restart</button>
        <select id="aiLevel" class="btn">
          <option value="easy">AI: Easy</option>
          <option value="normal" selected>AI: Normal</option>
          <option value="hard">AI: Hard</option>
          <option value="pro">AI: Pro</option>
        </select>
        <button class="btn" id="pHelp">How to play</button>
        <button class="btn" style="margin-left:auto" onclick="show('landing')">Back</button>
        <div class="turn" id="turnBadge">Your turn</div>
      </div>

      <div id="pOuter" class="table">
        <div id="pFrame">
          <canvas id="pCanvas" width="1000" height="520"></canvas>
        </div>
        <div style="padding:10px">
          <div class="power"><div id="powerFill"></div></div>
          <div class="rails">
            <div id="railYou"></div>
            <div id="railAI"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- help bubble -->
  <div class="help" id="help" aria-hidden="true">
    <div class="box">
      <button class="btn small close" id="helpX">✕</button>
      <h3>How to Play 8-Ball</h3>
      <ol>
        <li>Player breaks. First legally potted ball assigns groups: <b>solids</b> (1–7) or <b>stripes</b> (9–15).</li>
        <li>On your turn, aim by dragging from the cue ball; pull back to set <b>power</b>; release to shoot.</li>
        <li>If no legal ball drops and the cue ball sinks, it’s a <b>scratch</b> (ball-in-hand for opponent).</li>
        <li>Pocket the <b>8-ball</b> only after your group is cleared. Potting it early is a loss.</li>
        <li>AI difficulty changes aim error &amp; power discipline.</li>
      </ol>
    </div>
  </div>
</div>

<script>
/* ----------------- helpers & persistence ----------------- */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const store={k:'cosmic.games.v13',load(){try{return JSON.parse(localStorage.getItem(this.k))||{}}catch(e){return{}}},save(x){localStorage.setItem(this.k,JSON.stringify(x))}};
let state=Object.assign({user:'',bank:1000,selectedAvatar:0,selectedAvatarData:null,cardText:'—',cardColor:'#7aa2ff',mute:false},store.load());
function money(n){return '$'+n.toLocaleString()}

/* sounds */
const sounds={
  ding:new Audio('data:audio/mp3;base64,//uQZAAAAAAAAAAAA...'), // (short embedded or leave empty if you prefer)
  lose:new Audio('data:audio/mp3;base64,//uQZAAAAAAAAAAAA...'),
  cash:new Audio('data:audio/mp3;base64,//uQZAAAAAAAAAAAA...')
}
Object.values(sounds).forEach(a=>{a.volume=.5});

/* UI boot */
name.value=state.user||'';
bank.textContent=money(state.bank);
btnMute.textContent=state.mute?'🔈':'🔊';
btnMute.onclick=()=>{state.mute=!state.mute;btnMute.textContent=state.mute?'🔈':'🔊';store.save(state)}

/* avatar grid */
const AVA = [
  '🛰️','👨‍🚀','👩‍🚀','🛸','🪐','🌌','🌟','🦾','🧠','😎','👑','🃏','8️⃣','🎱','😈'
];
function drawAvatarPreview(){
  const svg=encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='96' height='96'><rect width='100%' height='100%' rx='14' ry='14' fill='#101a3b'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-size='42'>${AVA[state.selectedAvatar]||'🪐'}</text></svg>`);
  avatarPreview.src='data:image/svg+xml;utf8,'+svg;
  $('#playerAvatar').style.backgroundImage=`url('${avatarPreview.src}')`;
  $('#playerAvatar').style.backgroundSize='cover';
}
function buildGrid(){
  avatarGrid.innerHTML='';
  AVA.forEach((icon,i)=>{
    const svg=encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='92' height='92'><rect width='100%' height='100%' rx='12' ry='12' fill='${i===state.selectedAvatar?'#1b2a6a':'#0d1439'}' stroke='#2a338b'/><text x='50%' y='56%' dominant-baseline='middle' text-anchor='middle' font-size='36'>${icon}</text></svg>`);
    const img=document.createElement('img');
    img.src='data:image/svg+xml;utf8,'+svg;
    img.style='width:92px;height:92px;border-radius:12px;cursor:pointer';
    img.onclick=()=>{state.selectedAvatar=i;drawAvatarPreview();buildGrid();store.save(state)};
    avatarGrid.appendChild(img);
  });
}
saveAvatar.onclick=()=>{store.save(state);alert('Saved!')};

/* top actions */
saveName.onclick=()=>{state.user=name.value.trim()||'Player';store.save(state);bjUser.textContent=state.user}
btnCustom.onclick=()=>{show('customize')}

/* show pages (guard pool resize) */
function show(id){
  ['landing','customize','blackjack','pool'].forEach(n=>$('#'+n).classList.toggle('hidden',n!==id));
  if(id==='pool' && typeof window.resizePool==='function') window.resizePool();
}

/* ----------------- Blackjack ----------------- */
(function(){
  const suits=['♠','♥','♦','♣'];
  const deckBase=[];for(let s=0;s<4;s++)for(let r=1;r<=13;r++)deckBase.push({r,s});
  let deck=[], player=[], dealer=[], bet=0, tray=[], roundOver=true, lastChip=0, chipTimer=0;

  function shuffle(){deck=deckBase.slice();for(let i=deck.length-1;i>0;i--){const j=0|Math.random()*(i+1);[deck[i],deck[j]]=[deck[j],deck[i]]}}
  function draw(){return deck.pop()}
  function val(hand){
    let t=0,a=0;for(const c of hand){let v=c.r>10?10:c.r; if(v===1){v=11;a++} t+=v}
    while(t>21&&a>0){t-=10;a--}return t
  }
  function cardNode(c){
    if(!c) return el('div','card back');
    const red=(c.s===1||c.s===2);const n="A23456789TJQK"[c.r===1?0:(c.r>10?c.r-1:c.r)];
    const node=el('div','card '+(red?'red':'black'));
    node.innerHTML=`<div class="s">${n}</div><div style="font-size:28px">${suits[c.s]}</div><div class="s">${n}</div>`;
    return node;
  }
  function el(tag,cls){const d=document.createElement(tag);if(cls)d.className=cls;return d}
  function render(){
    dealerHand.innerHTML=''; playerHand.innerHTML='';
    dealer.forEach((c,i)=>dealerHand.appendChild(cardNode((i===1&&!roundOver)?null:c)));
    player.forEach(c=>playerHand.appendChild(cardNode(c)));
    dealerVal.textContent = roundOver? val(dealer): '—';
    playerVal.textContent = val(player);
    bjBal.textContent = money(state.bank);
    bjUser.textContent = state.user||'Player';
  }

  function settle(){
    roundOver=true;
    const pv=val(player), dv=val(dealer);
    if(pv>21){ msg('You bust. Dealer wins.','loss'); play('lose'); state.bank=Math.max(0,state.bank-bet); }
    else if(dv>21 || pv>dv){ msg('You win!','win'); play('cash'); state.bank+=bet; }
    else if(pv<dv){ msg('Dealer wins.','loss'); play('lose'); state.bank=Math.max(0,state.bank-bet); }
    else { msg('Push.'); }
    tray=[]; bet=0; chipTray.innerHTML='';
    store.save(state); render();
  }

  function msg(t,cls){bjMsg.classList.remove('loss','win'); if(cls) bjMsg.classList.add(cls); bjMsg.textContent=t}
  function placeChip(v){
    const now=performance.now();
    if(now-chipTimer<220) return; // throttle single click burst
    chipTimer=now;
    if(state.bank<v) return;
    state.bank-=v; bet+=v; tray.push(v);
    const chip=document.createElement('div');chip.className='chip-emoji';chip.textContent={'10':'🟢','25':'🔵','50':'🔴','100':'⚫','500':'🟣','1000':'🟡'}[v];
    chip.style.outline='3px solid '+({'10':'var(--chip-g)','25':'var(--chip-b)','50':'var(--chip-r)','100':'var(--chip-k)','500':'var(--chip-p)','1000':'var(--chip-y)'}[v]);
    chipTray.appendChild(chip); render();
    store.save(state);
  }

  function undo(){if(!tray.length) return; const v=tray.pop(); bet-=v; state.bank+=v; chipTray.removeChild(chipTray.lastChild); render(); store.save(state)}
  function clearBet(){ while(tray.length) undo(); }

  function deal(){
    if(bet<=0){ msg('Select a bet first.'); return;}
    roundOver=false; shuffle(); player=[draw(),draw()]; dealer=[draw(),draw()]; render(); msg('Good luck!');
    // instant 21
    if(val(player)===21){ setTimeout(()=>{ while(val(dealer)<17) dealer.push(draw()); render(); settle(); }, 600); return; }
  }
  function hit(){ if(roundOver) return; player.push(draw()); render(); if(val(player)>=21){ setTimeout(()=>{ while(val(dealer)<17) dealer.push(draw()); render(); settle(); },500) } }
  function stand(){ if(roundOver) return; while(val(dealer)<17) dealer.push(draw()); render(); settle(); }
  function dbl(){ if(roundOver||state.bank<bet) return; state.bank-=bet; bet*=2; store.save(state); render(); hit(); if(!roundOver) stand(); }
  function newRound(){ roundOver=true; bet=0; tray=[]; chipTray.innerHTML=''; dealer=[]; player=[]; msg('Place your bet to begin.'); render(); }

  // controls
  btnDeal.onclick=deal; btnHit.onclick=hit; btnStand.onclick=stand; btnDouble.onclick=dbl; btnNewRound.onclick=newRound;
  btnUndo.onclick=undo; btnClear.onclick=clearBet;
  $$('.chip-emoji').forEach(b=>b.onclick=()=>placeChip(+(b.dataset.chip)));

  // fullscreen for table
  const bjWrap=$('#blackjack .card'); const inFs=()=>document.fullscreenElement;
  const req=el=>el.requestFullscreen?el.requestFullscreen():el.webkitRequestFullscreen&&el.webkitRequestFullscreen();
  const ex=_=>document.exitFullscreen&&document.exitFullscreen();
  const sync=()=>{bjFsIn.classList.toggle('hidden',!!inFs());bjFsOut.classList.toggle('hidden',!inFs())}
  bjFsIn.onclick=()=>req(bjWrap); bjFsOut.onclick=ex; document.addEventListener('fullscreenchange',sync);

  // boot render
  drawAvatarPreview(); buildGrid(); render(); sync();
})();

/* ----------------- 8-Ball Pool with AI (fixed & improved) ----------------- */
(function(){
  const cvs=$('#pCanvas'), ctx=cvs.getContext('2d'), outer=$('#pOuter'), frame=$('#pFrame');
  const fsIn=$('#pFull'), fsOut=$('#pExit'), restart=$('#pRestart'), levelSel=$('#aiLevel');
  const powerFill=$('#powerFill'); const badge=$('#turnBadge');
  const help=$('#help'), helpBtn=$('#pHelp'), helpX=$('#helpX');
  const railYou=$('#railYou'), railAI=$('#railAI');

  let W=cvs.width, H=cvs.height, R=11, FRICTION=0.992, REST=0.02, POCKET=20, rail=18;
  let balls=[], pockets=[], power=0, pulling=false, aimStart=null, mouse={x:W/2,y:H/2};
  let turn='player', groups={player:null, ai:null}, rails={player:[], ai:[]}, needAssign=true, ballInHand=false;

  const COLORS={1:'#f94144',2:'#f3722c',3:'#f8961e',4:'#f9844a',5:'#f9c74f',6:'#90be6d',7:'#43aa8b',8:'#000',9:'#f94144',10:'#f3722c',11:'#f8961e',12:'#f9844a',13:'#f9c74f',14:'#90be6d',15:'#43aa8b'};
  const aiLevels={easy:{aimErr:.18,powVar:.40}, normal:{aimErr:.10,powVar:.22}, hard:{aimErr:.05,powVar:.14}, pro:{aimErr:.02,powVar:.08}};

  function setTurn(t){turn=t; badge.textContent=(t==='player'?'Your turn':'AI turn')}
  function newBall(x,y,color,id,type){return {x,y,vx:0,vy:0,r:R,color,id:id||0,type:type||'neutral',in:false}}
  function typeOf(n){return n===8?'eight':(n<=7?'solid':'stripe')}
  function cue(){return balls[0]}

  function rack(){
    balls=[]; balls.push(newBall(W*0.25,H*0.5,'#ffffff',0,'cue'));
    const order=[1,10,2,8,3,11,4,12,5,13,6,14,7,15,9]; let cx=W*0.66, cy=H*0.5, idx=0;
    for(let r=0;r<5;r++) for(let c=0;c<=r;c++){ const n=order[idx++]; const x=cx+r*(R*2-1), y=cy-(r*R)+c*R*2; balls.push(newBall(x,y,COLORS[n],n,typeOf(n)))}
    pockets=[{x:rail,y:rail},{x:W/2,y:rail-6},{x:W-rail,y:rail},{x:rail,y:H-rail},{x:W/2,y:H-rail+6},{x:W-rail,y:H-rail}];
    groups.player=null; groups.ai=null; rails.player=[]; rails.ai=[]; needAssign=true; setTurn('player'); ballInHand=false; renderRails();
  }
  function renderRails(){
    const c=n=>COLORS[n]||'#fff', mk=a=>a.map(n=>`<span class="balldot" style="background:${c(n)}"></span>`).join('');
    railYou.innerHTML=`<span class="title">You: ${groups.player?('<b>'+(groups.player==='solid'?'Solids':'Stripes')+'</b>'):'—'}</span> ${mk(rails.player)}`;
    railAI.innerHTML =`<span class="title">AI: ${groups.ai?('<b>'+(groups.ai==='solid'?'Solids':'Stripes')+'</b>'):'—'}</span> ${mk(rails.ai)}`;
  }

  function drawTable(){
    ctx.clearRect(0,0,W,H);
    let g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#0d3a38'); g.addColorStop(1,'#082725');
    ctx.fillStyle=g; ctx.fillRect(rail,rail,W-rail*2,H-rail*2);
    ctx.lineWidth=rail; ctx.strokeStyle='#213245'; ctx.strokeRect(rail/2,rail/2,W-rail,H-rail);
    ctx.fillStyle='#a7c4ff55'; for(let i=1;i<6;i++){ctx.fillRect(rail+(W-2*rail)*i/6-2,rail-6,4,12); ctx.fillRect(rail+(W-2*rail)*i/6-2,H-6,4,12);}
    for(const p of pockets){ctx.beginPath(); ctx.arc(p.x,p.y,POCKET,0,6.28); ctx.fillStyle='#0a0a0a'; ctx.fill();}
  }
  function drawBalls(){
    for(const b of balls){ if(b.in) continue;
      const sh=ctx.createRadialGradient(b.x-b.r*0.4,b.y-b.r*0.4,b.r*0.2,b.x,b.y,b.r); sh.addColorStop(0,'#fff'); sh.addColorStop(.2,b.color); sh.addColorStop(1,b.color);
      ctx.fillStyle=sh; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,6.28); ctx.fill();
      if(b.type==='stripe'){ ctx.fillStyle='#fff'; ctx.fillRect(b.x-b.r,b.y-4,b.r*2,8); }
      if(b.id===8){ ctx.fillStyle='#111'; ctx.beginPath(); ctx.arc(b.x,b.y,6,0,6.28); ctx.fill(); ctx.fillStyle='#fff'; ctx.font='9px Arial Black'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('8',b.x,b.y+.2); }
    }
  }
  function physics(){
    for(const b of balls){ if(b.in) continue; b.x+=b.vx; b.y+=b.vy; b.vx*=FRICTION; b.vy*=FRICTION; if(Math.abs(b.vx)<REST) b.vx=0; if(Math.abs(b.vy)<REST) b.vy=0; }
    for(const b of balls){ if(b.in) continue;
      if(b.x-b.r<rail){b.x=rail+b.r;b.vx=Math.abs(b.vx);} if(b.x+b.r>W-rail){b.x=W-rail-b.r;b.vx=-Math.abs(b.vx);}
      if(b.y-b.r<rail){b.y=rail+b.r;b.vy=Math.abs(b.vy);} if(b.y+b.r>H-rail){b.y=H-rail-b.r;b.vy=-Math.abs(b.vy);}
    }
    for(let i=0;i<balls.length;i++) for(let j=i+1;j<balls.length;j++){
      const a=balls[i], b=balls[j]; if(a.in||b.in) continue;
      const dx=b.x-a.x, dy=b.y-a.y, d=Math.hypot(dx,dy), m=a.r+b.r;
      if(d>0&&d<m){ const nx=dx/d, ny=dy/d, p=(a.vx*nx+a.vy*ny)-(b.vx*nx+b.vy*ny);
        if(p>0){ a.vx-=p*nx; a.vy-=p*ny; b.vx+=p*nx; b.vy+=p*ny; }
        const ov=m-d; a.x-=nx*ov/2; a.y-=ny*ov/2; b.x+=nx*ov/2; b.y+=ny*ov/2;
      }
    }
    const potted=[];
    for(const b of balls){ if(b.in) continue; for(const p of pockets){ if(Math.hypot(b.x-p.x,b.y-p.y)<POCKET-3){ b.in=true;b.vx=b.vy=0;potted.push(b);break; } } }
    if(!potted.length) return;
    let legal=false, scratched=false, eight=false;
    for(const b of potted){
      if(b.type==='cue'){ scratched=true; b.in=false; ballInHand=true; b.x=W*0.25; b.y=H*0.5; b.vx=b.vy=0; }
      else if(b.type==='eight'){ eight=true; }
      else{
        if(needAssign){
          if(turn==='player'){ groups.player=b.type; groups.ai=(b.type==='solid')?'stripe':'solid'; needAssign=false; }
          else { groups.ai=b.type; groups.player=(b.type==='solid')?'stripe':'solid'; needAssign=false; }
        }
        if((turn==='player'&&b.type===groups.player)||(turn==='ai'&&b.type===groups.ai)){ legal=true; (turn==='player'?rails.player:rails.ai).push(b.id); }
        else (turn==='player'?rails.ai:rails.player).push(b.id);
      }
    }
    renderRails();

    if(eight){
      const need = balls.some(x=>!x.in && (x.type==='solid'||x.type==='stripe') && ((turn==='player' && x.type===groups.player) || (turn==='ai' && x.type===groups.ai)));
      badge.textContent = need ? (turn==='player'?'AI wins (early 8)':'You win (early 8 by AI)') : (turn==='player'?'You win!':'AI wins!');
      setTimeout(()=>rack(),1500); return;
    }
    if(!(legal && !scratched)) setTurn(turn==='player'?'ai':'player');
  }
  const rolling=()=>balls.some(b=>!b.in&&(Math.abs(b.vx)>REST||Math.abs(b.vy)>REST));

  cvs.addEventListener('mousemove',e=>{
    const r=cvs.getBoundingClientRect(); mouse.x=(e.clientX-r.left)*cvs.width/r.width; mouse.y=(e.clientY-r.top)*cvs.height/r.height;
    if(pulling){ power=Math.min(100, Math.hypot(mouse.x-aimStart.x, mouse.y-aimStart.y)/2); powerFill.style.width=power+'%'; }
  });
  cvs.addEventListener('mousedown',e=>{
    if(turn!=='player'||rolling()) return;
    if(ballInHand){
      const cb=cue(); const r=cvs.getBoundingClientRect(); const x=(e.clientX-r.left)*cvs.width/r.width, y=(e.clientY-r.top)*cvs.height/r.height;
      if(x>rail+R && x<W-rail-R && y>rail+R && y<H-rail-R){ cb.x=x; cb.y=y; ballInHand=false; } return;
    }
    const cb=cue(); if(!cb) return; pulling=true; aimStart={x:cb.x,y:cb.y}; power=0; powerFill.style.width='0%';
  });
  cvs.addEventListener('mouseup',e=>{
    if(turn!=='player'||!pulling) return; pulling=false;
    const cb=cue(); if(!cb) return; const dx=cb.x-mouse.x, dy=cb.y-mouse.y, len=Math.hypot(dx,dy)||1;
    const force=(power/8); if(force<.2) return; cb.vx+=(dx/len)*force; cb.vy+=(dy/len)*force; power=0; powerFill.style.width='0%';
  });

  function lineBlocked(ax,ay,bx,by,ignore){
    for(const o of balls){ if(o.in||o===ignore) continue;
      const vx=bx-ax, vy=by-ay; const wx=o.x-ax, wy=o.y-ay;
      const t=Math.max(0,Math.min(1,(wx*vx+wy*vy)/(vx*vx+vy*vy)));
      const px=ax+t*vx, py=ay+t*vy; if(Math.hypot(o.x-px,o.y-py) < o.r*1.08) return true;
    } return false;
  }
  function aiShoot(){
    const cb=cue(); if(!cb) return;
    const lvl={easy:{err:.18,p:1.0},normal:{err:.10,p:1.1},hard:{err:.05,p:1.2},pro:{err:.02,p:1.25}}[levelSel.value];
    let targets=balls.filter(b=>!b.in && b.type!=='cue' && (groups.ai? (b.type===groups.ai||b.type==='eight'):b.type!=='eight'));
    if(!targets.length) targets=balls.filter(b=>!b.in && b.type==='eight');
    let best=null, score=-1;
    for(const b of targets){
      for(const p of pockets){
        const dx=p.x-b.x, dy=p.y-b.y, d=Math.hypot(dx,dy)||1;
        const gx=b.x-dx/d*b.r*2, gy=b.y-dy/d*b.r*2;
        if(lineBlocked(gx,gy,p.x,p.y,b)) continue;
        if(lineBlocked(cb.x,cb.y,gx,gy,b)) continue;
        const cut=Math.abs(Math.atan2(dy,dx));
        const dist=Math.hypot(cb.x-gx,cb.y-gy);
        const sc=1000-dist-cut*120-(b.type==='eight' && rails.ai.length<7?400:0);
        if(sc>score){ score=sc; best={b,gx,gy}; }
      }
    }
    if(!best){ const ang=Math.random()*6.28, pow=.8; cb.vx=Math.cos(ang)*pow; cb.vy=Math.sin(ang)*pow; return; }
    const err=(Math.random()*2-1)*lvl.err*120;
    const tx=best.gx+err, ty=best.gy+err;
    const dx=tx-cb.x, dy=ty-cb.y, len=Math.hypot(dx,dy)||1;
    const pow = Math.min(1.25, Math.max(.35, (Math.hypot(best.gx-best.b.x,best.gy-best.b.y)/160) + Math.random()*.22))*lvl.p;
    cb.vx=(dx/len)*pow*2.2; cb.vy=(dy/len)*pow*2.2;
  }

  function loop(){
    drawTable(); drawBalls();
    if(balls.length && turn==='player' && !rolling()){
      const cb=cue(); if(cb){
        const dx=mouse.x-cb.x, dy=mouse.y-cb.y, ang=Math.atan2(dy,dx), tipX=cb.x+Math.cos(ang)*cb.r, tipY=cb.y+Math.sin(ang)*cb.r, len=160+power*2;
        ctx.lineWidth=8; ctx.strokeStyle='#a67c52'; ctx.beginPath(); ctx.moveTo(tipX-Math.cos(ang)*len, tipY-Math.sin(ang)*len); ctx.lineTo(tipX,tipY); ctx.stroke();
        ctx.lineWidth=10; ctx.strokeStyle='#2a7bd3cc'; ctx.beginPath(); ctx.moveTo(tipX,tipY); ctx.lineTo(tipX+Math.cos(ang)*8, tipY+Math.sin(ang)*8); ctx.stroke();
      }
    }
    physics();
    if(!rolling() && turn==='ai' && !ballInHand){ aiShoot(); setTurn('player'); }
    requestAnimationFrame(loop);
  }

  // FS + resize hook
  const inFs=()=>document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement;
  const reqFs=el=>el.requestFullscreen?el.requestFullscreen():el.webkitRequestFullscreen?el.webkitRequestFullscreen():el.msRequestFullscreen&&el.msRequestFullscreen();
  const exitFs=_=>document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen();
  function ch(){const is=inFs(); fsIn.classList.toggle('hidden',is); fsOut.classList.toggle('hidden',!is); frame.style.maxWidth=is?'96vw':'1100px'}
  document.addEventListener('fullscreenchange',ch); document.addEventListener('webkitfullscreenchange',ch); document.addEventListener('MSFullscreenChange',ch);
  fsIn.onclick=()=>reqFs(outer); fsOut.onclick=()=>exitFs();

  // public (so show('pool') can safely call)
  window.resizePool=function(){ /* reserved for responsive math if you want to scale canvas */ };

  restart.onclick=()=>rack();

  // Help bubble
  function openHelp(){ help.style.display='flex'; help.setAttribute('aria-hidden','false'); helpX.focus(); }
  function closeHelp(){ help.style.display='none'; help.setAttribute('aria-hidden','true'); }
  helpBtn.onclick=openHelp; helpX.onclick=closeHelp; help.addEventListener('click',e=>{ if(e.target===help) closeHelp(); }); addEventListener('keydown',e=>{ if(e.key==='Escape') closeHelp(); });

  rack(); renderRails(); requestAnimationFrame(loop);
})();

/* ----------------- finalize boot ----------------- */
function play(k){ if(state.mute) return; if(sounds[k]) { try{ sounds[k].currentTime=0; sounds[k].play(); }catch(e){} } }
drawAvatarPreview(); buildGrid(); bjUser.textContent=state.user||'Player';
</script>
</body>
</html>
